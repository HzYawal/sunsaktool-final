<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunsakTool - ìˆí¼ ì˜ìƒ ì œì‘ê¸°</title>
    <!-- Google Fonts Link -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Gaegu&family=Gowun+Batang&family=Hi+Melody&family=IBM+Plex+Sans+KR&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@400;700&family=Noto+Serif+KR&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gmarket-sans-font@1.0.0/css/gmarket-sans.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼, ë ˆì´ì•„ì›ƒ ë“± (ê¸°ì¡´ê³¼ ê±°ì˜ ë™ì¼) */
        :root { --st-primary-color: #e82c43; --st-bg-color: #f8f9fa; --st-panel-bg: #fff; --st-border-color: #dee2e6; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--st-bg-color); color: #333; display: flex; height: 100vh; overflow: hidden; }
        .st-main-container { display: flex; width: 100%; height: 100%; }
        .st-script-panel, .st-preview-wrapper, .st-settings-panel-wrapper { padding: 15px; background-color: var(--st-panel-bg); display: flex; flex-direction: column; }
        .st-script-panel { width: 30%; border-right: 1px solid var(--st-border-color); }
        .st-preview-wrapper { flex-grow: 1; align-items: center; justify-content: flex-start; background: #f0f0f0; position: relative; } /* ê°€ì´ë“œë¼ì¸ ê¸°ì¤€ì  */
        .st-settings-panel-wrapper { width: 280px; border-left: 1px solid var(--st-border-color); overflow-y: auto; }

        /* ê³µí†µ ë²„íŠ¼ ë° ì»¨íŠ¸ë¡¤ */
        button, .st-action-btn { cursor: pointer; border: 1px solid var(--st-border-color); background: #fff; padding: 8px 12px; border-radius: 4px; transition: background-color 0.2s; }
        button:hover, .st-action-btn:hover { background-color: #f1f3f5; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 8px; border: 1px solid var(--st-border-color); border-radius: 4px; }
        
        /* ìŠ¤í¬ë¦½íŠ¸ ì¹´ë“œ ë¶€ë¶„ (ê¸°ì¡´ê³¼ ë™ì¼) */
        .st-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #st-card-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .st-card { border: 1px solid var(--st-border-color); border-radius: 6px; margin-bottom: 10px; background-color: #fff; position: relative; }
        .st-card.active { border-color: var(--st-primary-color); box-shadow: 0 0 5px rgba(232, 44, 67, 0.5); }
        .st-card-header { display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; padding: 5px 10px; border-bottom: 1px solid var(--st-border-color); }
        .st-card-drag-handle { cursor: move; }
        .st-card textarea { width: 100%; height: 80px; border: none; padding: 10px; resize: vertical; }
        .st-card-footer { display: flex; align-items: center; padding: 5px 10px; gap: 10px; font-size: 12px; color: #868e96; }
        input[type="file"] { display: none; }
        .st-card-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 10; }

        /* ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ (ê¸°ì¡´ ë ˆì´ì•„ì›ƒ ìœ ì§€) */
        #st-preview-panel { width: 360px; height: 640px; background-color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; margin-top: 20px; position: relative; }
        .st-preview-header { padding: 12px; text-align: center; color: white; font-weight: bold; flex-shrink: 0; }
        .st-preview-content { flex-grow: 1; display: flex; flex-direction: column; padding: 15px; }
        .st-project-info { text-align: center; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px; flex-shrink: 0; }
        .st-project-info .title { font-size: 20px; font-weight: bold; }
        .st-script-display { flex-grow: 1; display: flex; flex-direction: column; /* ê¸°ì¡´ ë ˆì´ì•„ì›ƒ ìœ ì§€ */ justify-content: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */ }
        #st-preview-text-container, #st-preview-image-container {
            /* âœ¨ ê¸°ì¡´ ë ˆì´ì•„ì›ƒì„ í•´ì¹˜ì§€ ì•Šë„ë¡ position: static ìœ ì§€ âœ¨ */
            touch-action: none; /* interact.js ê¶Œì¥ì‚¬í•­ */
            border: 2px solid transparent;
            cursor: move;
            transition: border-color 0.2s;
        }
        #st-preview-text-container.interactive-active, #st-preview-image-container.interactive-active {
            border-color: var(--st-primary-color);
            z-index: 100;
        }
        #st-preview-text { padding: 10px; white-space: pre-wrap; word-break: break-all; text-align: center; }
        #st-preview-image-container { margin-top: 15px; } /* âœ¨ ê¸°ì¡´ ê°„ê²© ìœ ì§€ âœ¨ */
        #st-preview-image { width: 100%; height: auto; object-fit: contain; display: block; }
        
        /* ìŠ¤ë§ˆíŠ¸ ê°€ì´ë“œ ë¼ì¸ */
        .snap-guide-v { position: absolute; top: 0; bottom: 0; width: 1px; background-color: var(--st-primary-color); display: none; z-index: 999; }

        /* ì„¤ì • íŒ¨ë„ (Accordion) */
        .st-accordion-item { border-bottom: 1px solid var(--st-border-color); }
        .st-accordion-header { background: #f8f9fa; padding: 10px; cursor: pointer; font-weight: bold; }
        .st-accordion-content { padding: 15px; display: none; }
        .st-accordion-item.active .st-accordion-content { display: block; }
        .st-control-group, .st-flex-group { margin-bottom: 15px; }
        .st-flex-group { display: flex; gap: 10px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .st-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .st-modal.visible { display: flex; }
        .st-modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; }
        .st-modal-content h2 { margin-bottom: 15px; }
        .st-modal-content textarea { height: 200px; }
        .st-modal-footer { margin-top: 15px; text-align: right; }
        .st-modal-footer button { margin-left: 10px; }
    </style>
</head>
<body>

    <audio id="st-tts-player"></audio>
    <audio id="st-bgm-player" loop></audio>
    <audio id="st-sfx-player"></audio>
    
    <div class="st-main-container">
        <!-- ìŠ¤í¬ë¦½íŠ¸ íŒ¨ë„ -->
        <div class="st-script-panel">
            <div class="st-panel-header">
                <h2>ìŠ¤í¬ë¦½íŠ¸ ëª©ë¡</h2>
                <div>
                    <button id="st-btn-add-gpts">GPTs</button>
                    <button id="st-btn-add-card">ì¶”ê°€ +</button>
                </div>
            </div>
            <div id="st-card-container"></div>
        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ -->
        <div class="st-preview-wrapper">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button id="st-btn-play-all">â–¶ ì „ì²´ ì¬ìƒ</button>
                <button id="st-btn-export-video">ğŸ¬ ì˜ìƒ ì¶œë ¥ (1080p)</button>
            </div>
            <!-- ìŠ¤ë§ˆíŠ¸ ê°€ì´ë“œ ë¼ì¸ (ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜) -->
            <div class="snap-guide-v"></div>
            <div id="st-preview-panel">
                 <div class="st-preview-header"></div>
                 <div class="st-preview-content">
                     <div class="st-project-info">
                         <div class="title"></div>
                         <span></span>
                     </div>
                     <div class="st-script-display">
                        <!-- âœ¨ ê¸°ì¡´ ë ˆì´ì•„ì›ƒì„ ìœ ì§€í•˜ëŠ” ì»¨í…Œì´ë„ˆë“¤ âœ¨ -->
                        <div id="st-preview-text-container">
                            <div id="st-preview-text"></div>
                        </div>
                        <div id="st-preview-image-container">
                            <img id="st-preview-image">
                        </div>
                     </div>
                 </div>
            </div>
        </div>

        <!-- ì„¤ì • íŒ¨ë„ -->
        <div class="st-settings-panel-wrapper">
            <div id="st-settings-panel"></div>
        </div>
    </div>

    <!-- GPTs ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="st-modal-gpts" class="st-modal">
        <div class="st-modal-content">
            <h2>GPTs ìŠ¤í¬ë¦½íŠ¸ ë¶™ì—¬ë„£ê¸°</h2>
            <p style="font-size:14px; color:#666; margin-bottom:10px;">GPTsì—ì„œ ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ë¥¼ ë³µì‚¬í•˜ì—¬ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. ë¹ˆ ì¤„ì„ ê¸°ì¤€ìœ¼ë¡œ ì¹´ë“œê°€ ìë™ìœ¼ë¡œ ë‚˜ë‰©ë‹ˆë‹¤.</p>
            <textarea id="st-gpts-textarea" placeholder="ì—¬ê¸°ì— ìŠ¤í¬ë¦½íŠ¸ ë¶™ì—¬ë„£ê¸°..."></textarea>
            <div class="st-modal-footer">
                <button id="st-btn-gpts-cancel">ì·¨ì†Œ</button>
                <button id="st-btn-gpts-confirm" style="background-color: var(--st-primary-color); color: white;">í™•ì¸</button>
            </div>
        </div>
    </div>
    
    <!-- BGM í¸ì§‘ê¸° ëª¨ë‹¬ (ìƒëµ) -->

    <!-- âœ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìŠ¤í¬ë¦½íŠ¸ âœ¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.4.0/wavesurfer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.4.0/plugin/wavesurfer.regions.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ìƒìˆ˜ ë° ì „ì—­ ë³€ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼) ---
        const FONT_LIST = [ { name: 'í”„ë¦¬í…ë‹¤ë“œ (ë³¸ë¬¸ìš© ì¶”ì²œ)', value: 'Pretendard' }, { name: 'Noto Sans KR (ê¸°ë³¸ ê³ ë”•)', value: "'Noto Sans KR', sans-serif" }, { name: 'Gë§ˆì¼“ ì‚°ìŠ¤ (ê°œì„±ìˆëŠ” ì œëª©)', value: 'GmarketSans' }, { name: 'IBM Plex Sans KR (ëª¨ë˜í•œ ê³ ë”•)', value: "'IBM Plex Sans KR', sans-serif" }, { name: 'Do Hyeon (ë ˆíŠ¸ë¡œ ì œëª©)', value: "'Do Hyeon', sans-serif" }, { name: 'ë‚˜ëˆ”ëª…ì¡° (ê°ì„±ì ì¸ ë³¸ë¬¸)', value: "'Nanum Myeongjo', serif" }, { name: 'ê³ ìš´ ë°”íƒ• (ë¶€ë“œëŸ¬ìš´ ëª…ì¡°)', value: "'Gowun Batang', serif" }, { name: 'Black Han Sans (ê°•ë ¥í•œ ì œëª©)', value: "'Black Han Sans', sans-serif" }, { name: 'ê°œêµ¬ (ê·€ì—¬ìš´ ì†ê¸€ì”¨)', value: "'Gaegu', cursive" }, { name: 'Hi Melody (ì•„ê¸°ìê¸° ì†ê¸€ì”¨)', value: "'Hi Melody', cursive" }, { name: 'Noto Serif KR (ì •ê°ˆí•œ ëª…ì¡°)', value: "'Noto Serif KR', serif" }, { name: 'ìŠ¤í¬ì¹´ í•œ ì‚°ìŠ¤ ë„¤ì˜¤ (ê¹”ë”í•œ ë³¸ë¬¸)', value: "'Spoqa Han Sans Neo', sans-serif" }, { name: 'ë…ë„ (ê±°ì¹œ ë¶“ê¸€ì”¨)', value: "'Dokdo', cursive" }, ];
        const BGM_LIST = [ { name: 'ì„ íƒ ì•ˆí•¨', url: '' }, { name: 'big-cafe', url: 'https://sunsaktool-final.netlify.app/big-cafe.mp3' }, { name: 'blue-jacket', url: 'https://sunsaktool-final.netlify.app/blue-jacket.mp3' }, { name: 'cute-puppy', url: 'https://sunsaktool-final.netlify.app/cute-puppy.mp3' }, { name: 'laughter-in-the-breeze', url: 'https://sunsaktool-final.netlify.app/laughter-in-the-breeze-_happy_.mp3' }, { name: 'murder-in-my-mind', url: 'https://sunsaktool-final.netlify.app/murder-in-my-mind.mp3' }, { name: 'smiley-composure', url: 'https://sunsaktool-final.netlify.app/smiley-composure.mp3' }, { name: 'spider', url: 'https://sunsaktool-final.netlify.app/spider.mp3' }, { name: 'white-color', url: 'https://sunsaktool-final.netlify.app/white-color.mp3' } ];
        const SFX_LIST = [ { name: 'íš¨ê³¼ìŒ ì—†ìŒ', url: '' }, { name: 'ë¾± (ë¬¼ë°©ìš¸)', url: `https://sunsaktool-final.netlify.app/sfx/062_${encodeURIComponent('ë¾± (ë¬¼ë°©ìš¸)')}.mp3` }, { name: 'ì°°ì¹µ (ì¹´ë©”ë¼)', url: `https://sunsaktool-final.netlify.app/sfx/078_${encodeURIComponent('ì°°ì¹µ (ì¹´ë©”ë¼)')}.mp3` }, /* ...ë‚˜ë¨¸ì§€ SFX ìƒëµ... */ ];
        let globalBGM = { url: null, volume: 0.3, startTime: 0, endTime: null };
        let scriptCards = [];
        let isPlaying = false;
        let ttsCache = new Map();
        let selectedCardId = null;

        const cardContainer = document.getElementById('st-card-container');
        // ... ë‚˜ë¨¸ì§€ DOM ìš”ì†Œë“¤
        
        // --- âœ¨ ì¹´ë“œ ì¶”ê°€ í•¨ìˆ˜ (transform ë°ì´í„° êµ¬ì¡° ì¶”ê°€) --- âœ¨
        function addScriptCard(text = '') {
            const cardId = `card-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
            const cardData = {
                id: cardId, text, duration: 0.5, imageUrl: null, audioUrl: null, ttsReady: false, sfxUrl: null,
                style: {
                    fontFamily: "'Noto Sans KR', sans-serif",
                    fontSize: '24px',
                    color: '#000000',
                },
                // âœ¨ ìœ„ì¹˜/í¬ê¸° ì¡°ì •ì„ ìœ„í•œ transform ë°ì´í„° âœ¨
                transform: {
                    text:  { x: 0, y: 0, scale: 1 },
                    image: { x: 0, y: 0, scale: 1 }
                }
            };
            scriptCards.push(cardData);
            // ì¹´ë“œ HTML ìƒì„± ë° ì´ë²¤íŠ¸ ë°”ì¸ë”© (ê¸°ì¡´ê³¼ ë™ì¼)
            const cardEl = document.createElement('div'); cardEl.className = 'st-card'; cardEl.dataset.id = cardId; const sfxOptions = SFX_LIST.map(sfx => `<option value="${sfx.url || ''}">${sfx.name}</option>`).join(''); cardEl.innerHTML = `<div class="st-card-header st-card-drag-handle"><span class="st-card-number"></span><button class="st-btn-delete-card">ğŸ—‘ï¸</button></div> <textarea placeholder="ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">${text}</textarea> <div class="st-card-footer"> <button class="st-play-clip-btn" title="ë¯¸ë¦¬ë“£ê¸°" disabled>â–¶ï¸</button> <span class="st-duration-label">íƒ€ì„ë¼ì¸ (---ì´ˆ)</span> <label class="st-action-btn" for="${cardId}-file">ì´ë¯¸ì§€</label> <input type="file" id="${cardId}-file" accept="image/*"> <select class="st-sfx-select" style="width: auto; margin-left: auto;">${sfxOptions}</select> </div>`;
            cardContainer.appendChild(cardEl);
            const fileInput = cardEl.querySelector(`#${cardId}-file`); fileInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { const reader = new FileReader(); reader.onload = (event) => { cardData.imageUrl = event.target.result; if (selectedCardId === cardId) { updatePreviewDisplay(); } }; reader.readAsDataURL(e.target.files[0]); } });
            cardEl.querySelector('.st-play-clip-btn').addEventListener('click', (e) => { e.stopPropagation(); if (isPlaying) stopPlayback(); if (cardData.ttsReady && cardData.audioUrl) { ttsPlayer.src = cardData.audioUrl; ttsPlayer.play(); } });
            cardEl.querySelector('.st-sfx-select').addEventListener('change', (e) => { cardData.sfxUrl = e.target.value || null; });
            const debouncedFetchAndUpdate = debounce(async (newText, id) => { const cardToUpdate = scriptCards.find(c => c.id === id); const ttsData = await fetchTTS(newText, id); if (ttsData && cardToUpdate) { cardToUpdate.duration = ttsData.duration; cardToUpdate.audioUrl = ttsData.audioUrl; cardToUpdate.ttsReady = true; const currentCardEl = document.querySelector(`.st-card[data-id="${id}"]`); if(currentCardEl) { currentCardEl.querySelector('.st-duration-label').textContent = `íƒ€ì„ë¼ì¸ (${ttsData.duration.toFixed(2)}ì´ˆ)`; currentCardEl.querySelector('.st-play-clip-btn').disabled = false; } } }, 800);
            cardEl.querySelector('textarea').addEventListener('input', (e) => { cardData.text = e.target.value; debouncedFetchAndUpdate(cardData.text, cardId); if (selectedCardId === cardId) { updatePreviewDisplay(); } });
            cardEl.querySelector('.st-btn-delete-card').addEventListener('click', (e) => { e.stopPropagation(); deleteCard(cardId); });
            cardEl.addEventListener('click', () => selectCard(cardId)); if (text) debouncedFetchAndUpdate(text, cardId); if (!selectedCardId) selectCard(cardId); updateCardNumbers();
        }
        
        // --- âœ¨ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (transform ì ìš©) --- âœ¨
        function updatePreviewDisplay() {
            // í—¤ë”, í”„ë¡œì íŠ¸ ì •ë³´ ë“± ê¸°ì¡´ ë¡œì§ (ìƒëµ)
            const headerEl = document.querySelector('.st-preview-header'); /* ... */
            const titleEl = document.querySelector('.st-project-info .title'); /* ... */
            const metaEl = document.querySelector('.st-project-info span'); /* ... */
            
            const card = scriptCards.find(c => c.id === selectedCardId);
            const textContainer = document.getElementById('st-preview-text-container');
            const imageContainer = document.getElementById('st-preview-image-container');
            const textEl = document.getElementById('st-preview-text');
            const imageEl = document.getElementById('st-preview-image');

            if (card) {
                textEl.textContent = card.text;
                Object.assign(textEl.style, card.style);

                if (card.imageUrl) {
                    imageEl.src = card.imageUrl;
                    imageContainer.style.display = 'block';
                } else {
                    imageContainer.style.display = 'none';
                    imageEl.src = '';
                }

                // âœ¨ ì €ì¥ëœ transform ê°’ ì ìš© âœ¨
                const applyTransform = (el, transform) => {
                    el.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
                };
                applyTransform(textContainer, card.transform.text);
                applyTransform(imageContainer, card.transform.image);

            } else {
                // ì„ íƒëœ ì¹´ë“œê°€ ì—†ì„ ë•Œ ì´ˆê¸°í™”
                textEl.textContent = 'ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”.';
                imageContainer.style.display = 'none';
                textContainer.style.transform = 'translate(0px, 0px) scale(1)';
                imageContainer.style.transform = 'translate(0px, 0px) scale(1)';
            }
        }
        
        // --- âœ¨ Interact.js ì´ˆê¸°í™” ë° ë¡œì§ (ê°œì„ ëœ ë²„ì „) --- âœ¨
        function initializeInteract() {
            const verticalGuide = document.querySelector('.snap-guide-v');
            const previewPanel = document.getElementById('st-preview-panel');

            const updateTransform = (target, transformData) => {
                 target.style.transform = `translate(${transformData.x}px, ${transformData.y}px) scale(${transformData.scale})`;
            }
            
            interact('#st-preview-text-container, #st-preview-image-container')
                .draggable({
                    listeners: {
                        start(event) {
                            event.target.classList.add('interactive-active');
                        },
                        move(event) {
                            const card = scriptCards.find(c => c.id === selectedCardId);
                            if (!card) return;
                            
                            const type = event.target.id.includes('text') ? 'text' : 'image';
                            const transformData = card.transform[type];

                            transformData.x += event.dx;
                            transformData.y += event.dy;
                            updateTransform(event.target, transformData);

                            // âœ¨ ìŠ¤ë§ˆíŠ¸ ê°€ì´ë“œ ë¡œì§ (ê°œì„ ) âœ¨
                            const targetRect = event.target.getBoundingClientRect();
                            const panelRect = previewPanel.getBoundingClientRect();
                            const targetCenter = targetRect.left + targetRect.width / 2;
                            const panelCenter = panelRect.left + panelRect.width / 2;
                            
                            if (Math.abs(targetCenter - panelCenter) < 5) {
                                verticalGuide.style.left = `${previewPanel.offsetWidth / 2}px`;
                                verticalGuide.style.display = 'block';
                                // ìŠ¤ëƒ… ê¸°ëŠ¥
                                transformData.x -= (targetCenter - panelCenter);
                                updateTransform(event.target, transformData);
                            } else {
                                verticalGuide.style.display = 'none';
                            }
                        },
                        end(event) {
                             verticalGuide.style.display = 'none';
                        }
                    },
                    modifiers: [ // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì œí•œ
                        interact.modifiers.restrictRect({
                            restriction: previewPanel,
                            endOnly: true
                        })
                    ]
                })
                .resizable({
                    edges: { top: false, left: true, bottom: false, right: true }, // ì¢Œìš°ë¡œë§Œ í¬ê¸° ì¡°ì ˆ
                    listeners: {
                        move: function (event) {
                            const card = scriptCards.find(c => c.id === selectedCardId);
                            if (!card) return;
                            const type = event.target.id.includes('text') ? 'text' : 'image';
                            const transformData = card.transform[type];
                            
                            // ìŠ¤ì¼€ì¼ ê°’ ë³€ê²½ìœ¼ë¡œ í¬ê¸° ì¡°ì ˆ
                            const oldWidth = event.rect.width - event.deltaRect.width;
                            const scaleChange = event.rect.width / oldWidth;
                            transformData.scale *= scaleChange;
                            
                            // ìœ„ì¹˜ ë³´ì • (ì¤‘ì‹¬ì„ ê¸°ì¤€ìœ¼ë¡œ í¬ê¸° ì¡°ì ˆ)
                            transformData.x += event.deltaRect.left / 2;
                            
                            updateTransform(event.target, transformData);
                        }
                    }
                });
        }
        
        // --- ë‚˜ë¨¸ì§€ ìœ í‹¸ë¦¬í‹° ë° ì´ˆê¸°í™” í•¨ìˆ˜ë“¤ (ê¸°ì¡´ê³¼ ë™ì¼) ---
        // fetchTTS, deleteCard, renderControls ë“±ë“±ì˜ í•¨ìˆ˜ëŠ” ìƒëµ...
        // ì½”ë“œê°€ ë„ˆë¬´ ê¸¸ì–´ì ¸ì„œ í•µì‹¬ ë¡œì§ ì™¸ì—ëŠ” ìƒëµí–ˆìŠµë‹ˆë‹¤.
        // ìœ„ì— ì œê³µëœ ì „ì²´ ì½”ë“œì—ëŠ” ëª¨ë“  í•¨ìˆ˜ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
        const debounce = (callback, delay) => { /* ... */ };
        const getAudioDuration = (url) => { /* ... */ };
        async function fetchTTS(text, cardId) { /* ... */ } // ê¸°ì¡´ê³¼ ë™ì¼
        function renderControls() { /* ... */ } // ê¸°ì¡´ê³¼ ë™ì¼
        function deleteCard(cardId) { /* ... */ } // ê¸°ì¡´ê³¼ ë™ì¼
        function updateCardNumbers() { document.querySelectorAll('.st-card').forEach((card, index) => { card.querySelector('.st-card-number').textContent = index + 1; }); }
        function showLoadingOnCard(cardId, show, message = 'ìŒì„± ìƒì„± ì¤‘...') { /* ... */ }
        function selectCard(cardId, fromPlayback = false) { if (isPlaying && !fromPlayback) stopPlayback(); selectedCardId = cardId; document.querySelectorAll('.st-card').forEach(c => c.classList.remove('active')); document.querySelectorAll('.interactive-active').forEach(el => el.classList.remove('interactive-active')); const cardEl = document.querySelector(`.st-card[data-id="${cardId}"]`); if (cardEl) { cardEl.classList.add('active'); if (!fromPlayback) cardEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); updateScriptStyleControls(); updatePreviewDisplay(); } else { updatePreviewDisplay(); } }
        function updateScriptStyleControls() { /* ... */ }
        function applyScriptStylesToSelectedCard() { const card = scriptCards.find(c => c.id === selectedCardId); if (!card) return; card.style = { ...card.style, color: document.getElementById('st-setting-script-color').value, fontFamily: document.getElementById('st-setting-script-font').value, fontSize: document.getElementById('st-setting-script-size').value + 'px' }; updatePreviewDisplay(); }
        // ... (ê¸°íƒ€ ëª¨ë“  í•¨ìˆ˜)
        function setupExportButton() { const exportBtn = document.getElementById('st-btn-export-video'); if (!exportBtn) return; exportBtn.addEventListener('click', async () => { /* ... */ const projectData = { /* ... */ scenes: scriptCards.map(card => ({ /* ... */ style: card.style, transform: card.transform })) }; /* ... */ }); }
        
        function initialize() {
            renderControls(); 
            updatePreviewDisplay(); 
            addCardBtn.addEventListener('click', () => addScriptCard('')); 
            // ... (ê¸°íƒ€ ì´ˆê¸°í™” ì½”ë“œ)
            new Sortable(cardContainer, { /* ... */ });
            
            initializeInteract();
            setupExportButton(); // âœ¨ transform ë°ì´í„°ë„ í•¨ê»˜ ë‚´ë³´ë‚´ë„ë¡ ìˆ˜ì • í•„ìš”
            
            addScriptCard('SunsakToolì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!');
        }
        
        initialize();
    });
    </script>
</body>
</html>
