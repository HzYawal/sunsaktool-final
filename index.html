<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunsakTool - 숏폼 영상 제작기</title>
    <!-- Google Fonts Link -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Gaegu&family=Gowun+Batang&family=Hi+Melody&family=IBM+Plex+Sans+KR&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@400;700&family=Noto+Serif+KR&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gmarket-sans-font@1.0.0/css/gmarket-sans.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

    <style>
        /* 기본 스타일, 레이아웃 등 */
        :root { --st-primary-color: #e82c43; --st-bg-color: #f8f9fa; --st-panel-bg: #fff; --st-border-color: #dee2e6; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--st-bg-color); color: #333; display: flex; height: 100vh; overflow: hidden; }
        .st-main-container { display: flex; width: 100%; height: 100%; }
        .st-script-panel, .st-preview-wrapper, .st-settings-panel-wrapper { padding: 15px; background-color: var(--st-panel-bg); display: flex; flex-direction: column; }
        .st-script-panel { width: 30%; border-right: 1px solid var(--st-border-color); }
        .st-preview-wrapper { flex-grow: 1; align-items: center; justify-content: flex-start; background: #f0f0f0; position: relative; } /* 가이드라인 기준점 */
        .st-settings-panel-wrapper { width: 280px; border-left: 1px solid var(--st-border-color); overflow-y: auto; }
        
        /* 공통 버튼 및 컨트롤 */
        button, .st-action-btn { cursor: pointer; border: 1px solid var(--st-border-color); background: #fff; padding: 8px 12px; border-radius: 4px; transition: background-color 0.2s; }
        button:hover, .st-action-btn:hover { background-color: #f1f3f5; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 8px; border: 1px solid var(--st-border-color); border-radius: 4px; }
        
        /* 스크립트 카드 부분 */
        .st-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #st-card-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .st-card { border: 1px solid var(--st-border-color); border-radius: 6px; margin-bottom: 10px; background-color: #fff; position: relative; }
        .st-card.active { border-color: var(--st-primary-color); box-shadow: 0 0 5px rgba(232, 44, 67, 0.5); }
        .st-card-header { display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; padding: 5px 10px; border-bottom: 1px solid var(--st-border-color); }
        .st-card-drag-handle { cursor: move; }
        .st-card textarea { width: 100%; height: 80px; border: none; padding: 10px; resize: vertical; }
        .st-card-footer { display: flex; align-items: center; padding: 5px 10px; gap: 10px; font-size: 12px; color: #868e96; }
        input[type="file"] { display: none; }
        .st-card-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 10; }

        /* 미리보기 패널 (기존 레이아웃 유지) */
        #st-preview-panel {
            width: 360px;
            height: 640px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-top: 20px;
            position: relative; /* 스마트 가이드 기준점 */
        }
        .st-preview-header {
            padding: 12px;
            text-align: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0; /* ✨ 헤더 크기 고정 ✨ */
        }
        .st-preview-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }
        .st-project-info {
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            flex-shrink: 0; /* 크기 고정 */
        }
        .st-project-info .title {
            font-size: 20px;
            font-weight: bold;
        }
        /* ✨ 원본 코드를 복원합니다. ✨ */
        .st-script-display {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            /* justify-content 제거. 원래 레이아웃으로 */
        }
        #st-preview-text-container, #st-preview-image-container {
            border: 2px solid transparent;
            cursor: move;
            transition: border-color 0.2s;
            touch-action: none;
        }
        #st-preview-text-container.interactive-active, #st-preview-image-container.interactive-active {
            border-color: var(--st-primary-color);
            z-index: 100;
        }
        #st-preview-text {
            /* ✨ 원본 레이아웃 복원 ✨ */
            transform-origin: center;
        }
        #st-preview-image-container {
            margin-top: 16px; /* ✨ 사용자님이 맞춘 16px 간격! ✨ */
            transform-origin: center;
        }
        #st-preview-image {
            width: 100%;
            height: auto;
            object-fit: contain;
            display: block;
        }
        
        /* 스마트 가이드 라인 */
        .snap-guide-v {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: var(--st-primary-color);
            display: none;
            z-index: 999;
        }

        /* 설정 패널 (Accordion) */
        /* ... (이하 동일) ... */
    </style>
</head>
<body>
    <!-- HTML 구조는 이전과 동일 -->
    <audio id="st-tts-player"></audio>
    <audio id="st-bgm-player" loop></audio>
    <audio id="st-sfx-player"></audio>
    
    <div class="st-main-container">
        <!-- 스크립트 패널 -->
        <div class="st-script-panel">
            <div class="st-panel-header">
                <h2>스크립트 목록</h2>
                <div>
                    <button id="st-btn-add-gpts">GPTs</button>
                    <button id="st-btn-add-card">추가 +</button>
                </div>
            </div>
            <div id="st-card-container"></div>
        </div>

        <!-- 미리보기 패널 -->
        <div class="st-preview-wrapper">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button id="st-btn-play-all">▶ 전체 재생</button>
                <button id="st-btn-export-video">🎬 영상 출력 (1080p)</button>
            </div>
            <div class="snap-guide-v"></div>
            <div id="st-preview-panel">
                 <div class="st-preview-header"></div>
                 <div class="st-preview-content">
                     <div class="st-project-info">
                         <div class="title"></div>
                         <span></span>
                     </div>
                     <div class="st-script-display">
                        <div id="st-preview-text-container">
                            <div id="st-preview-text"></div>
                        </div>
                        <div id="st-preview-image-container">
                            <img id="st-preview-image">
                        </div>
                     </div>
                 </div>
            </div>
        </div>
        <!-- ... (이하 HTML 동일) ... -->
    </div>
    
    <!-- 라이브러리 스크립트 -->
    <!-- ... (이하 동일) ... -->

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 상수 및 전역 변수 ---
        // ... (이전과 동일)
        
        // --- ✨ 카드 추가 함수 (transform 데이터 구조 유지) --- ✨
        function addScriptCard(text = '') {
            const cardId = `card-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
            const cardData = {
                id: cardId, text, duration: 0.5, imageUrl: null, audioUrl: null, ttsReady: false, sfxUrl: null,
                style: {
                    fontFamily: "'Noto Sans KR', sans-serif",
                    fontSize: '24px',
                    color: '#000000',
                },
                // ✨ 위치/크기 조정을 위한 transform 데이터 (초기값은 0, 1로 고정) ✨
                transform: {
                    text:  { x: 0, y: 0, scale: 1 },
                    image: { x: 0, y: 0, scale: 1 }
                }
            };
            scriptCards.push(cardData);
            // 카드 HTML 생성 및 이벤트 바인딩 (이전과 동일)
            // ...
        }
        
        // --- ✨ 미리보기 업데이트 함수 (완전 복원) --- ✨
        function updatePreviewDisplay() {
            // 헤더, 프로젝트 정보 등 기존 로직
            const headerEl = document.querySelector('.st-preview-header'); /* ... */
            
            const card = scriptCards.find(c => c.id === selectedCardId);
            const textContainer = document.getElementById('st-preview-text-container');
            const imageContainer = document.getElementById('st-preview-image-container');
            const textEl = document.getElementById('st-preview-text');
            const imageEl = document.getElementById('st-preview-image');

            if (card) {
                // 텍스트와 이미지 내용 업데이트
                textEl.textContent = card.text;
                Object.assign(textEl.style, card.style);

                if (card.imageUrl) {
                    imageEl.src = card.imageUrl;
                    imageContainer.style.display = 'block';
                } else {
                    imageContainer.style.display = 'none';
                    imageEl.src = '';
                }

                // ✨ 저장된 transform 값 적용 (핵심) ✨
                const applyTransform = (el, transform) => {
                    el.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
                };
                applyTransform(textContainer, card.transform.text);
                applyTransform(imageContainer, card.transform.image);
            } else {
                // 선택된 카드가 없을 때 초기화 (스크린샷처럼 보이도록)
                textEl.textContent = '스크립트를 추가하거나 선택하세요.';
                Object.assign(textEl.style, { fontFamily: 'Noto Sans KR', fontSize: '16px', color: '#555' });
                imageContainer.style.display = 'none';
                
                // transform 초기화
                textContainer.style.transform = 'translate(0px, 0px) scale(1)';
                imageContainer.style.transform = 'translate(0px, 0px) scale(1)';
            }
        }
        
        // --- ✨ Interact.js 초기화 및 로직 (개선) --- ✨
        function initializeInteract() {
            const verticalGuide = document.querySelector('.snap-guide-v');
            const previewPanel = document.getElementById('st-preview-panel');

            // ... (나머지 로직은 이전과 동일하므로 전체 코드를 참고해주세요)
        }
        
        // --- 나머지 유틸리티 및 초기화 함수들 ---
        // ... (생략된 모든 함수는 이전과 동일합니다)

        function initialize() {
            renderControls(); 
            // ✨ 첫 화면이 스크린샷처럼 보이도록 수정 ✨
            // addScriptCard를 바로 호출하지 않고, 초기 뷰를 먼저 그림
            updatePreviewDisplay(); 

            addCardBtn.addEventListener('click', () => {
                if(scriptCards.length === 0) {
                     addScriptCard('SunsakTool에 오신 것을 환영합니다!');
                } else {
                     addScriptCard('');
                }
            }); 
            // ... (기타 초기화 코드)
            
            initializeInteract();
        }
        
        initialize();
    });
    </script>
</body>
</html>
