<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunsakTool - 숏폼 영상 제작기</title>
    <!-- Google Fonts Link -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Gaegu&family=Gowun+Batang&family=Hi+Melody&family=IBM+Plex+Sans+KR&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@400;700&family=Noto+Serif+KR&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gmarket-sans-font@1.0.0/css/gmarket-sans.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

    <style>
        /* 기본 스타일, 레이아웃 등 (기존과 거의 동일) */
        :root { --st-primary-color: #e82c43; --st-bg-color: #f8f9fa; --st-panel-bg: #fff; --st-border-color: #dee2e6; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--st-bg-color); color: #333; display: flex; height: 100vh; overflow: hidden; }
        .st-main-container { display: flex; width: 100%; height: 100%; }
        .st-script-panel, .st-preview-wrapper, .st-settings-panel-wrapper { padding: 15px; background-color: var(--st-panel-bg); display: flex; flex-direction: column; }
        .st-script-panel { width: 30%; border-right: 1px solid var(--st-border-color); }
        .st-preview-wrapper { flex-grow: 1; align-items: center; justify-content: flex-start; background: #f0f0f0; position: relative; } /* 가이드라인 기준점 */
        .st-settings-panel-wrapper { width: 280px; border-left: 1px solid var(--st-border-color); overflow-y: auto; }

        /* 공통 버튼 및 컨트롤 */
        button, .st-action-btn { cursor: pointer; border: 1px solid var(--st-border-color); background: #fff; padding: 8px 12px; border-radius: 4px; transition: background-color 0.2s; }
        button:hover, .st-action-btn:hover { background-color: #f1f3f5; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 8px; border: 1px solid var(--st-border-color); border-radius: 4px; }
        
        /* 스크립트 카드 부분 (기존과 동일) */
        .st-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #st-card-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .st-card { border: 1px solid var(--st-border-color); border-radius: 6px; margin-bottom: 10px; background-color: #fff; position: relative; }
        .st-card.active { border-color: var(--st-primary-color); box-shadow: 0 0 5px rgba(232, 44, 67, 0.5); }
        .st-card-header { display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; padding: 5px 10px; border-bottom: 1px solid var(--st-border-color); }
        .st-card-drag-handle { cursor: move; }
        .st-card textarea { width: 100%; height: 80px; border: none; padding: 10px; resize: vertical; }
        .st-card-footer { display: flex; align-items: center; padding: 5px 10px; gap: 10px; font-size: 12px; color: #868e96; }
        input[type="file"] { display: none; }
        .st-card-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 10; }

        /* 미리보기 패널 (기존 레이아웃 유지) */
        #st-preview-panel { width: 360px; height: 640px; background-color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; margin-top: 20px; position: relative; }
        .st-preview-header { padding: 12px; text-align: center; color: white; font-weight: bold; flex-shrink: 0; }
        .st-preview-content { flex-grow: 1; display: flex; flex-direction: column; padding: 15px; }
        .st-project-info { text-align: center; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px; flex-shrink: 0; }
        .st-project-info .title { font-size: 20px; font-weight: bold; }
        .st-script-display { flex-grow: 1; display: flex; flex-direction: column; /* 기존 레이아웃 유지 */ justify-content: center; /* 세로 중앙 정렬 */ }
        #st-preview-text-container, #st-preview-image-container {
            /* ✨ 기존 레이아웃을 해치지 않도록 position: static 유지 ✨ */
            touch-action: none; /* interact.js 권장사항 */
            border: 2px solid transparent;
            cursor: move;
            transition: border-color 0.2s;
        }
        #st-preview-text-container.interactive-active, #st-preview-image-container.interactive-active {
            border-color: var(--st-primary-color);
            z-index: 100;
        }
        #st-preview-text { padding: 10px; white-space: pre-wrap; word-break: break-all; text-align: center; }
        #st-preview-image-container { margin-top: 15px; } /* ✨ 기존 간격 유지 ✨ */
        #st-preview-image { width: 100%; height: auto; object-fit: contain; display: block; }
        
        /* 스마트 가이드 라인 */
        .snap-guide-v { position: absolute; top: 0; bottom: 0; width: 1px; background-color: var(--st-primary-color); display: none; z-index: 999; }

        /* 설정 패널 (Accordion) */
        .st-accordion-item { border-bottom: 1px solid var(--st-border-color); }
        .st-accordion-header { background: #f8f9fa; padding: 10px; cursor: pointer; font-weight: bold; }
        .st-accordion-content { padding: 15px; display: none; }
        .st-accordion-item.active .st-accordion-content { display: block; }
        .st-control-group, .st-flex-group { margin-bottom: 15px; }
        .st-flex-group { display: flex; gap: 10px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; }

        /* 모달 스타일 */
        .st-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .st-modal.visible { display: flex; }
        .st-modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; }
        .st-modal-content h2 { margin-bottom: 15px; }
        .st-modal-content textarea { height: 200px; }
        .st-modal-footer { margin-top: 15px; text-align: right; }
        .st-modal-footer button { margin-left: 10px; }
    </style>
</head>
<body>

    <audio id="st-tts-player"></audio>
    <audio id="st-bgm-player" loop></audio>
    <audio id="st-sfx-player"></audio>
    
    <div class="st-main-container">
        <!-- 스크립트 패널 -->
        <div class="st-script-panel">
            <div class="st-panel-header">
                <h2>스크립트 목록</h2>
                <div>
                    <button id="st-btn-add-gpts">GPTs</button>
                    <button id="st-btn-add-card">추가 +</button>
                </div>
            </div>
            <div id="st-card-container"></div>
        </div>

        <!-- 미리보기 패널 -->
        <div class="st-preview-wrapper">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button id="st-btn-play-all">▶ 전체 재생</button>
                <button id="st-btn-export-video">🎬 영상 출력 (1080p)</button>
            </div>
            <!-- 스마트 가이드 라인 (미리보기 패널 기준으로 위치) -->
            <div class="snap-guide-v"></div>
            <div id="st-preview-panel">
                 <div class="st-preview-header"></div>
                 <div class="st-preview-content">
                     <div class="st-project-info">
                         <div class="title"></div>
                         <span></span>
                     </div>
                     <div class="st-script-display">
                        <!-- ✨ 기존 레이아웃을 유지하는 컨테이너들 ✨ -->
                        <div id="st-preview-text-container">
                            <div id="st-preview-text"></div>
                        </div>
                        <div id="st-preview-image-container">
                            <img id="st-preview-image">
                        </div>
                     </div>
                 </div>
            </div>
        </div>

        <!-- 설정 패널 -->
        <div class="st-settings-panel-wrapper">
            <div id="st-settings-panel"></div>
        </div>
    </div>

    <!-- GPTs 스크립트 추가 모달 -->
    <div id="st-modal-gpts" class="st-modal">
        <div class="st-modal-content">
            <h2>GPTs 스크립트 붙여넣기</h2>
            <p style="font-size:14px; color:#666; margin-bottom:10px;">GPTs에서 생성된 스크립트 전체를 복사하여 아래에 붙여넣으세요. 빈 줄을 기준으로 카드가 자동으로 나뉩니다.</p>
            <textarea id="st-gpts-textarea" placeholder="여기에 스크립트 붙여넣기..."></textarea>
            <div class="st-modal-footer">
                <button id="st-btn-gpts-cancel">취소</button>
                <button id="st-btn-gpts-confirm" style="background-color: var(--st-primary-color); color: white;">확인</button>
            </div>
        </div>
    </div>
    
    <!-- BGM 편집기 모달 (생략) -->

    <!-- ✨ 라이브러리 스크립트 ✨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.4.0/wavesurfer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.4.0/plugin/wavesurfer.regions.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 상수 및 전역 변수 (기존과 동일) ---
        const FONT_LIST = [ { name: '프리텐다드 (본문용 추천)', value: 'Pretendard' }, { name: 'Noto Sans KR (기본 고딕)', value: "'Noto Sans KR', sans-serif" }, { name: 'G마켓 산스 (개성있는 제목)', value: 'GmarketSans' }, { name: 'IBM Plex Sans KR (모던한 고딕)', value: "'IBM Plex Sans KR', sans-serif" }, { name: 'Do Hyeon (레트로 제목)', value: "'Do Hyeon', sans-serif" }, { name: '나눔명조 (감성적인 본문)', value: "'Nanum Myeongjo', serif" }, { name: '고운 바탕 (부드러운 명조)', value: "'Gowun Batang', serif" }, { name: 'Black Han Sans (강력한 제목)', value: "'Black Han Sans', sans-serif" }, { name: '개구 (귀여운 손글씨)', value: "'Gaegu', cursive" }, { name: 'Hi Melody (아기자기 손글씨)', value: "'Hi Melody', cursive" }, { name: 'Noto Serif KR (정갈한 명조)', value: "'Noto Serif KR', serif" }, { name: '스포카 한 산스 네오 (깔끔한 본문)', value: "'Spoqa Han Sans Neo', sans-serif" }, { name: '독도 (거친 붓글씨)', value: "'Dokdo', cursive" }, ];
        const BGM_LIST = [ { name: '선택 안함', url: '' }, { name: 'big-cafe', url: 'https://sunsaktool-final.netlify.app/big-cafe.mp3' }, { name: 'blue-jacket', url: 'https://sunsaktool-final.netlify.app/blue-jacket.mp3' }, { name: 'cute-puppy', url: 'https://sunsaktool-final.netlify.app/cute-puppy.mp3' }, { name: 'laughter-in-the-breeze', url: 'https://sunsaktool-final.netlify.app/laughter-in-the-breeze-_happy_.mp3' }, { name: 'murder-in-my-mind', url: 'https://sunsaktool-final.netlify.app/murder-in-my-mind.mp3' }, { name: 'smiley-composure', url: 'https://sunsaktool-final.netlify.app/smiley-composure.mp3' }, { name: 'spider', url: 'https://sunsaktool-final.netlify.app/spider.mp3' }, { name: 'white-color', url: 'https://sunsaktool-final.netlify.app/white-color.mp3' } ];
        const SFX_LIST = [ { name: '효과음 없음', url: '' }, { name: '뾱 (물방울)', url: `https://sunsaktool-final.netlify.app/sfx/062_${encodeURIComponent('뾱 (물방울)')}.mp3` }, { name: '찰칵 (카메라)', url: `https://sunsaktool-final.netlify.app/sfx/078_${encodeURIComponent('찰칵 (카메라)')}.mp3` }, /* ...나머지 SFX 생략... */ ];
        let globalBGM = { url: null, volume: 0.3, startTime: 0, endTime: null };
        let scriptCards = [];
        let isPlaying = false;
        let ttsCache = new Map();
        let selectedCardId = null;

        const cardContainer = document.getElementById('st-card-container');
        // ... 나머지 DOM 요소들
        
        // --- ✨ 카드 추가 함수 (transform 데이터 구조 추가) --- ✨
        function addScriptCard(text = '') {
            const cardId = `card-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
            const cardData = {
                id: cardId, text, duration: 0.5, imageUrl: null, audioUrl: null, ttsReady: false, sfxUrl: null,
                style: {
                    fontFamily: "'Noto Sans KR', sans-serif",
                    fontSize: '24px',
                    color: '#000000',
                },
                // ✨ 위치/크기 조정을 위한 transform 데이터 ✨
                transform: {
                    text:  { x: 0, y: 0, scale: 1 },
                    image: { x: 0, y: 0, scale: 1 }
                }
            };
            scriptCards.push(cardData);
            // 카드 HTML 생성 및 이벤트 바인딩 (기존과 동일)
            const cardEl = document.createElement('div'); cardEl.className = 'st-card'; cardEl.dataset.id = cardId; const sfxOptions = SFX_LIST.map(sfx => `<option value="${sfx.url || ''}">${sfx.name}</option>`).join(''); cardEl.innerHTML = `<div class="st-card-header st-card-drag-handle"><span class="st-card-number"></span><button class="st-btn-delete-card">🗑️</button></div> <textarea placeholder="스크립트를 입력하세요...">${text}</textarea> <div class="st-card-footer"> <button class="st-play-clip-btn" title="미리듣기" disabled>▶️</button> <span class="st-duration-label">타임라인 (---초)</span> <label class="st-action-btn" for="${cardId}-file">이미지</label> <input type="file" id="${cardId}-file" accept="image/*"> <select class="st-sfx-select" style="width: auto; margin-left: auto;">${sfxOptions}</select> </div>`;
            cardContainer.appendChild(cardEl);
            const fileInput = cardEl.querySelector(`#${cardId}-file`); fileInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { const reader = new FileReader(); reader.onload = (event) => { cardData.imageUrl = event.target.result; if (selectedCardId === cardId) { updatePreviewDisplay(); } }; reader.readAsDataURL(e.target.files[0]); } });
            cardEl.querySelector('.st-play-clip-btn').addEventListener('click', (e) => { e.stopPropagation(); if (isPlaying) stopPlayback(); if (cardData.ttsReady && cardData.audioUrl) { ttsPlayer.src = cardData.audioUrl; ttsPlayer.play(); } });
            cardEl.querySelector('.st-sfx-select').addEventListener('change', (e) => { cardData.sfxUrl = e.target.value || null; });
            const debouncedFetchAndUpdate = debounce(async (newText, id) => { const cardToUpdate = scriptCards.find(c => c.id === id); const ttsData = await fetchTTS(newText, id); if (ttsData && cardToUpdate) { cardToUpdate.duration = ttsData.duration; cardToUpdate.audioUrl = ttsData.audioUrl; cardToUpdate.ttsReady = true; const currentCardEl = document.querySelector(`.st-card[data-id="${id}"]`); if(currentCardEl) { currentCardEl.querySelector('.st-duration-label').textContent = `타임라인 (${ttsData.duration.toFixed(2)}초)`; currentCardEl.querySelector('.st-play-clip-btn').disabled = false; } } }, 800);
            cardEl.querySelector('textarea').addEventListener('input', (e) => { cardData.text = e.target.value; debouncedFetchAndUpdate(cardData.text, cardId); if (selectedCardId === cardId) { updatePreviewDisplay(); } });
            cardEl.querySelector('.st-btn-delete-card').addEventListener('click', (e) => { e.stopPropagation(); deleteCard(cardId); });
            cardEl.addEventListener('click', () => selectCard(cardId)); if (text) debouncedFetchAndUpdate(text, cardId); if (!selectedCardId) selectCard(cardId); updateCardNumbers();
        }
        
        // --- ✨ 미리보기 업데이트 함수 (transform 적용) --- ✨
        function updatePreviewDisplay() {
            // 헤더, 프로젝트 정보 등 기존 로직 (생략)
            const headerEl = document.querySelector('.st-preview-header'); /* ... */
            const titleEl = document.querySelector('.st-project-info .title'); /* ... */
            const metaEl = document.querySelector('.st-project-info span'); /* ... */
            
            const card = scriptCards.find(c => c.id === selectedCardId);
            const textContainer = document.getElementById('st-preview-text-container');
            const imageContainer = document.getElementById('st-preview-image-container');
            const textEl = document.getElementById('st-preview-text');
            const imageEl = document.getElementById('st-preview-image');

            if (card) {
                textEl.textContent = card.text;
                Object.assign(textEl.style, card.style);

                if (card.imageUrl) {
                    imageEl.src = card.imageUrl;
                    imageContainer.style.display = 'block';
                } else {
                    imageContainer.style.display = 'none';
                    imageEl.src = '';
                }

                // ✨ 저장된 transform 값 적용 ✨
                const applyTransform = (el, transform) => {
                    el.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
                };
                applyTransform(textContainer, card.transform.text);
                applyTransform(imageContainer, card.transform.image);

            } else {
                // 선택된 카드가 없을 때 초기화
                textEl.textContent = '스크립트를 추가하거나 선택하세요.';
                imageContainer.style.display = 'none';
                textContainer.style.transform = 'translate(0px, 0px) scale(1)';
                imageContainer.style.transform = 'translate(0px, 0px) scale(1)';
            }
        }
        
        // --- ✨ Interact.js 초기화 및 로직 (개선된 버전) --- ✨
        function initializeInteract() {
            const verticalGuide = document.querySelector('.snap-guide-v');
            const previewPanel = document.getElementById('st-preview-panel');

            const updateTransform = (target, transformData) => {
                 target.style.transform = `translate(${transformData.x}px, ${transformData.y}px) scale(${transformData.scale})`;
            }
            
            interact('#st-preview-text-container, #st-preview-image-container')
                .draggable({
                    listeners: {
                        start(event) {
                            event.target.classList.add('interactive-active');
                        },
                        move(event) {
                            const card = scriptCards.find(c => c.id === selectedCardId);
                            if (!card) return;
                            
                            const type = event.target.id.includes('text') ? 'text' : 'image';
                            const transformData = card.transform[type];

                            transformData.x += event.dx;
                            transformData.y += event.dy;
                            updateTransform(event.target, transformData);

                            // ✨ 스마트 가이드 로직 (개선) ✨
                            const targetRect = event.target.getBoundingClientRect();
                            const panelRect = previewPanel.getBoundingClientRect();
                            const targetCenter = targetRect.left + targetRect.width / 2;
                            const panelCenter = panelRect.left + panelRect.width / 2;
                            
                            if (Math.abs(targetCenter - panelCenter) < 5) {
                                verticalGuide.style.left = `${previewPanel.offsetWidth / 2}px`;
                                verticalGuide.style.display = 'block';
                                // 스냅 기능
                                transformData.x -= (targetCenter - panelCenter);
                                updateTransform(event.target, transformData);
                            } else {
                                verticalGuide.style.display = 'none';
                            }
                        },
                        end(event) {
                             verticalGuide.style.display = 'none';
                        }
                    },
                    modifiers: [ // 화면 밖으로 나가지 않도록 제한
                        interact.modifiers.restrictRect({
                            restriction: previewPanel,
                            endOnly: true
                        })
                    ]
                })
                .resizable({
                    edges: { top: false, left: true, bottom: false, right: true }, // 좌우로만 크기 조절
                    listeners: {
                        move: function (event) {
                            const card = scriptCards.find(c => c.id === selectedCardId);
                            if (!card) return;
                            const type = event.target.id.includes('text') ? 'text' : 'image';
                            const transformData = card.transform[type];
                            
                            // 스케일 값 변경으로 크기 조절
                            const oldWidth = event.rect.width - event.deltaRect.width;
                            const scaleChange = event.rect.width / oldWidth;
                            transformData.scale *= scaleChange;
                            
                            // 위치 보정 (중심을 기준으로 크기 조절)
                            transformData.x += event.deltaRect.left / 2;
                            
                            updateTransform(event.target, transformData);
                        }
                    }
                });
        }
        
        // --- 나머지 유틸리티 및 초기화 함수들 (기존과 동일) ---
        // fetchTTS, deleteCard, renderControls 등등의 함수는 생략...
        // 코드가 너무 길어져서 핵심 로직 외에는 생략했습니다.
        // 위에 제공된 전체 코드에는 모든 함수가 포함되어 있습니다.
        const debounce = (callback, delay) => { /* ... */ };
        const getAudioDuration = (url) => { /* ... */ };
        async function fetchTTS(text, cardId) { /* ... */ } // 기존과 동일
        function renderControls() { /* ... */ } // 기존과 동일
        function deleteCard(cardId) { /* ... */ } // 기존과 동일
        function updateCardNumbers() { document.querySelectorAll('.st-card').forEach((card, index) => { card.querySelector('.st-card-number').textContent = index + 1; }); }
        function showLoadingOnCard(cardId, show, message = '음성 생성 중...') { /* ... */ }
        function selectCard(cardId, fromPlayback = false) { if (isPlaying && !fromPlayback) stopPlayback(); selectedCardId = cardId; document.querySelectorAll('.st-card').forEach(c => c.classList.remove('active')); document.querySelectorAll('.interactive-active').forEach(el => el.classList.remove('interactive-active')); const cardEl = document.querySelector(`.st-card[data-id="${cardId}"]`); if (cardEl) { cardEl.classList.add('active'); if (!fromPlayback) cardEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); updateScriptStyleControls(); updatePreviewDisplay(); } else { updatePreviewDisplay(); } }
        function updateScriptStyleControls() { /* ... */ }
        function applyScriptStylesToSelectedCard() { const card = scriptCards.find(c => c.id === selectedCardId); if (!card) return; card.style = { ...card.style, color: document.getElementById('st-setting-script-color').value, fontFamily: document.getElementById('st-setting-script-font').value, fontSize: document.getElementById('st-setting-script-size').value + 'px' }; updatePreviewDisplay(); }
        // ... (기타 모든 함수)
        function setupExportButton() { const exportBtn = document.getElementById('st-btn-export-video'); if (!exportBtn) return; exportBtn.addEventListener('click', async () => { /* ... */ const projectData = { /* ... */ scenes: scriptCards.map(card => ({ /* ... */ style: card.style, transform: card.transform })) }; /* ... */ }); }
        
        function initialize() {
            renderControls(); 
            updatePreviewDisplay(); 
            addCardBtn.addEventListener('click', () => addScriptCard('')); 
            // ... (기타 초기화 코드)
            new Sortable(cardContainer, { /* ... */ });
            
            initializeInteract();
            setupExportButton(); // ✨ transform 데이터도 함께 내보내도록 수정 필요
            
            addScriptCard('SunsakTool에 오신 것을 환영합니다!');
        }
        
        initialize();
    });
    </script>
</body>
</html>
