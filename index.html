<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunsakTool - ìˆí¼ ì˜ìƒ ì œì‘ê¸°</title>
    <!-- Google Fonts Link -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Gaegu&family=Gowun+Batang&family=Hi+Melody&family=IBM+Plex+Sans+KR&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@400;700&family=Noto+Serif+KR&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gmarket-sans-font@1.0.0/css/gmarket-sans.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼, ë ˆì´ì•„ì›ƒ ë“± */
        :root { --st-primary-color: #e82c43; --st-bg-color: #f8f9fa; --st-panel-bg: #fff; --st-border-color: #dee2e6; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--st-bg-color); color: #333; display: flex; height: 100vh; overflow: hidden; }
        .st-main-container { display: flex; width: 100%; height: 100%; }
        .st-script-panel, .st-preview-wrapper, .st-settings-panel-wrapper { padding: 15px; background-color: var(--st-panel-bg); display: flex; flex-direction: column; }
        .st-script-panel { width: 30%; border-right: 1px solid var(--st-border-color); }
        .st-preview-wrapper { flex-grow: 1; align-items: center; justify-content: flex-start; background: #f0f0f0; }
        .st-settings-panel-wrapper { width: 280px; border-left: 1px solid var(--st-border-color); overflow-y: auto; }

        /* ê³µí†µ ë²„íŠ¼ ë° ì»¨íŠ¸ë¡¤ */
        button, .st-action-btn { cursor: pointer; border: 1px solid var(--st-border-color); background: #fff; padding: 8px 12px; border-radius: 4px; transition: background-color 0.2s; }
        button:hover, .st-action-btn:hover { background-color: #f1f3f5; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 8px; border: 1px solid var(--st-border-color); border-radius: 4px; }
        
        /* ìŠ¤í¬ë¦½íŠ¸ ì¹´ë“œ ë¶€ë¶„ */
        .st-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #st-card-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .st-card { border: 1px solid var(--st-border-color); border-radius: 6px; margin-bottom: 10px; background-color: #fff; position: relative; }
        .st-card.active { border-color: var(--st-primary-color); box-shadow: 0 0 5px rgba(232, 44, 67, 0.5); }
        .st-card-header { display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; padding: 5px 10px; border-bottom: 1px solid var(--st-border-color); }
        .st-card-drag-handle { cursor: move; }
        .st-card textarea { width: 100%; height: 80px; border: none; padding: 10px; resize: vertical; }
        .st-card-footer { display: flex; align-items: center; padding: 5px 10px; gap: 10px; font-size: 12px; color: #868e96; }
        input[type="file"] { display: none; }
        .st-card-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 10; }

        /* ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ */
        #st-preview-panel { width: 360px; height: 640px; background-color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; margin-top: 20px; }
        .st-preview-header { padding: 12px; text-align: center; color: white; font-weight: bold; flex-shrink: 0; }
        .st-preview-content { flex-grow: 1; display: flex; flex-direction: column; padding: 15px; position: relative; }
        .st-project-info { text-align: center; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        .st-project-info .title { font-size: 20px; font-weight: bold; }
        
        /* âœ¨ ì¸í„°ë™ì…˜ ê¸°ëŠ¥ ê´€ë ¨ ìŠ¤íƒ€ì¼ âœ¨ */
        .st-script-display { flex-grow: 1; position: relative; /* ìì‹ ìš”ì†Œì˜ ê¸°ì¤€ì  */ overflow: hidden; background: #fdfdfd; border: 1px dashed #ccc; }
        #st-preview-text-container, #st-preview-image-container {
            position: absolute; /* ììœ ë¡œìš´ ìœ„ì¹˜ ì¡°ì •ì„ ìœ„í•´ */
            cursor: move;
            touch-action: none; /* interact.js ê¶Œì¥ì‚¬í•­ */
            min-width: 50px;
            min-height: 20px;
            border: 2px solid transparent;
        }
        #st-preview-text-container.interactive-active, #st-preview-image-container.interactive-active {
            border-color: var(--st-primary-color);
            z-index: 100;
        }
        #st-preview-text { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 10px; white-space: pre-wrap; word-break: break-all; }
        #st-preview-image { width: 100%; height: 100%; object-fit: cover; }
        .snap-guide-v { position: absolute; top: 0; bottom: 0; width: 1px; background-color: var(--st-primary-color); display: none; z-index: 999; }

        /* ì„¤ì • íŒ¨ë„ (Accordion) */
        .st-accordion-item { border-bottom: 1px solid var(--st-border-color); }
        .st-accordion-header { background: #f8f9fa; padding: 10px; cursor: pointer; font-weight: bold; }
        .st-accordion-content { padding: 15px; display: none; }
        .st-accordion-item.active .st-accordion-content { display: block; }
        .st-control-group, .st-flex-group { margin-bottom: 15px; }
        .st-flex-group { display: flex; gap: 10px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .st-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .st-modal.visible { display: flex; }
        .st-modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; }
        .st-modal-content h2 { margin-bottom: 15px; }
        .st-modal-content textarea { height: 200px; }
        .st-modal-footer { margin-top: 15px; text-align: right; }
        .st-modal-footer button { margin-left: 10px; }
    </style>
</head>
<body>

    <audio id="st-tts-player"></audio>
    <audio id="st-bgm-player" loop></audio>
    <audio id="st-sfx-player"></audio>
    
    <div class="st-main-container">
        <!-- ìŠ¤í¬ë¦½íŠ¸ íŒ¨ë„ -->
        <div class="st-script-panel">
            <div class="st-panel-header">
                <h2>ìŠ¤í¬ë¦½íŠ¸ ëª©ë¡</h2>
                <div>
                    <button id="st-btn-add-gpts">GPTs</button>
                    <button id="st-btn-add-card">ì¶”ê°€ +</button>
                </div>
            </div>
            <div id="st-card-container"></div>
        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ -->
        <div class="st-preview-wrapper">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button id="st-btn-play-all">â–¶ ì „ì²´ ì¬ìƒ</button>
                <button id="st-btn-export-video">ğŸ¬ ì˜ìƒ ì¶œë ¥ (1080p)</button>
            </div>
            <div id="st-preview-panel">
                 <div class="st-preview-header"></div>
                 <div class="st-preview-content">
                     <div class="st-project-info">
                         <div class="title"></div>
                         <span></span>
                     </div>
                     <div class="st-script-display">
                        <!-- ìŠ¤ë§ˆíŠ¸ ê°€ì´ë“œ ë¼ì¸ -->
                        <div class="snap-guide-v"></div>
                        
                        <!-- ì¸í„°ë™ì…˜ ëŒ€ìƒ ìš”ì†Œë“¤ -->
                        <div id="st-preview-image-container">
                            <img id="st-preview-image">
                        </div>
                        <div id="st-preview-text-container">
                            <div id="st-preview-text"></div>
                        </div>
                     </div>
                 </div>
            </div>
        </div>

        <!-- ì„¤ì • íŒ¨ë„ -->
        <div class="st-settings-panel-wrapper">
            <div id="st-settings-panel"></div>
        </div>
    </div>

    <!-- GPTs ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="st-modal-gpts" class="st-modal">
        <div class="st-modal-content">
            <h2>GPTs ìŠ¤í¬ë¦½íŠ¸ ë¶™ì—¬ë„£ê¸°</h2>
            <p style="font-size:14px; color:#666; margin-bottom:10px;">GPTsì—ì„œ ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ë¥¼ ë³µì‚¬í•˜ì—¬ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. ë¹ˆ ì¤„ì„ ê¸°ì¤€ìœ¼ë¡œ ì¹´ë“œê°€ ìë™ìœ¼ë¡œ ë‚˜ë‰©ë‹ˆë‹¤.</p>
            <textarea id="st-gpts-textarea" placeholder="ì—¬ê¸°ì— ìŠ¤í¬ë¦½íŠ¸ ë¶™ì—¬ë„£ê¸°..."></textarea>
            <div class="st-modal-footer">
                <button id="st-btn-gpts-cancel">ì·¨ì†Œ</button>
                <button id="st-btn-gpts-confirm" style="background-color: var(--st-primary-color); color: white;">í™•ì¸</button>
            </div>
        </div>
    </div>
    
    <!-- BGM í¸ì§‘ê¸° ëª¨ë‹¬ -->
    <div id="st-modal-bgm" class="st-modal">
        <!-- BGM í¸ì§‘ê¸° UIëŠ” ì œê³µëœ ì½”ë“œì— ì—†ì–´ì„œ ìƒëµí•©ë‹ˆë‹¤. ë¡œì§ì€ ìœ ì§€ë©ë‹ˆë‹¤. -->
    </div>


    <!-- âœ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìŠ¤í¬ë¦½íŠ¸ âœ¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.4.0/wavesurfer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.4.0/plugin/wavesurfer.regions.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- âœ¨ interact.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ âœ¨ -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ğŸš¨ API í‚¤ ê´€ë ¨ ì„¤ì •ì´ ëª¨ë‘ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
        
        const FONT_LIST = [ { name: 'í”„ë¦¬í…ë‹¤ë“œ (ë³¸ë¬¸ìš© ì¶”ì²œ)', value: 'Pretendard' }, { name: 'Noto Sans KR (ê¸°ë³¸ ê³ ë”•)', value: "'Noto Sans KR', sans-serif" }, { name: 'Gë§ˆì¼“ ì‚°ìŠ¤ (ê°œì„±ìˆëŠ” ì œëª©)', value: 'GmarketSans' }, { name: 'IBM Plex Sans KR (ëª¨ë˜í•œ ê³ ë”•)', value: "'IBM Plex Sans KR', sans-serif" }, { name: 'Do Hyeon (ë ˆíŠ¸ë¡œ ì œëª©)', value: "'Do Hyeon', sans-serif" }, { name: 'ë‚˜ëˆ”ëª…ì¡° (ê°ì„±ì ì¸ ë³¸ë¬¸)', value: "'Nanum Myeongjo', serif" }, { name: 'ê³ ìš´ ë°”íƒ• (ë¶€ë“œëŸ¬ìš´ ëª…ì¡°)', value: "'Gowun Batang', serif" }, { name: 'Black Han Sans (ê°•ë ¥í•œ ì œëª©)', value: "'Black Han Sans', sans-serif" }, { name: 'ê°œêµ¬ (ê·€ì—¬ìš´ ì†ê¸€ì”¨)', value: "'Gaegu', cursive" }, { name: 'Hi Melody (ì•„ê¸°ìê¸° ì†ê¸€ì”¨)', value: "'Hi Melody', cursive" }, { name: 'Noto Serif KR (ì •ê°ˆí•œ ëª…ì¡°)', value: "'Noto Serif KR', serif" }, { name: 'ìŠ¤í¬ì¹´ í•œ ì‚°ìŠ¤ ë„¤ì˜¤ (ê¹”ë”í•œ ë³¸ë¬¸)', value: "'Spoqa Han Sans Neo', sans-serif" }, { name: 'ë…ë„ (ê±°ì¹œ ë¶“ê¸€ì”¨)', value: "'Dokdo', cursive" }, ];
        const BGM_LIST = [ { name: 'ì„ íƒ ì•ˆí•¨', url: '' }, { name: 'big-cafe', url: 'https://sunsaktool-final.netlify.app/big-cafe.mp3' }, { name: 'blue-jacket', url: 'https://sunsaktool-final.netlify.app/blue-jacket.mp3' }, { name: 'cute-puppy', url: 'https://sunsaktool-final.netlify.app/cute-puppy.mp3' }, { name: 'laughter-in-the-breeze', url: 'https://sunsaktool-final.netlify.app/laughter-in-the-breeze-_happy_.mp3' }, { name: 'murder-in-my-mind', url: 'https://sunsaktool-final.netlify.app/murder-in-my-mind.mp3' }, { name: 'smiley-composure', url: 'https://sunsaktool-final.netlify.app/smiley-composure.mp3' }, { name: 'spider', url: 'https://sunsaktool-final.netlify.app/spider.mp3' }, { name: 'white-color', url: 'https://sunsaktool-final.netlify.app/white-color.mp3' } ];
        const SFX_LIST = [ { name: 'íš¨ê³¼ìŒ ì—†ìŒ', url: '' }, { name: 'ë¾± (ë¬¼ë°©ìš¸)', url: `https://sunsaktool-final.netlify.app/sfx/062_${encodeURIComponent('ë¾± (ë¬¼ë°©ìš¸)')}.mp3` }, { name: 'ì°°ì¹µ (ì¹´ë©”ë¼)', url: `https://sunsaktool-final.netlify.app/sfx/078_${encodeURIComponent('ì°°ì¹µ (ì¹´ë©”ë¼)')}.mp3` }, { name: 'ê¸°ì–´ 1', url: 'https://sunsaktool-final.netlify.app/sfx/gears 1.wav' }, { name: 'ê²Œì„í´ë¦¬ì–´ (ê³ ìŒ)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ê²Œì„í´ë¦¬ì–´ (ê³ ìŒ)')}.mp3` }, { name: 'ê¸ì •ì  ë§ˆë²• ì‚¬ìš©', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ê¸ì •ì  ë§ˆë²• ì‚¬ìš©')}.mp3` }, { name: 'ê¹¨ë‹¬ìŒ(ë¾°ë´‰)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ê¹¨ë‹¬ìŒì„ ì–»ì—ˆì„ ë•Œ(ë¾°ë´‰)')}.mp3` }, { name: 'ë†€ëŒ ë°˜ì „', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë†€ëŒ ë°˜ì „')}.mp3` }, { name: 'ë‹¤ìŒ ì¥ë©´ì „í™˜(ë¾°ë¡œë¡±)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë‹¤ìŒ ì¥ë©´ì „í™˜(ë¾°ë¡œë¡±)')}.mp3` }, { name: 'ë„˜ì–´ê°€ëŠ” ë§‘ì€ ì†Œë¦¬(ë ë§~)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ë§‘ì€ ì†Œë¦¬(ë ë§~)')}.mp3` }, { name: 'ë™ì „ë¨¹ëŠ”ì†Œë¦¬ 2ì—°ì†(ì¤‘ìŒ)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë™ì „ë¨¹ëŠ”ì†Œë¦¬ 2ì—°ì†(ì¤‘ìŒ)')}.mp3` }, { name: 'ë”©ë™ëŒ•ë™ (ì „ììŒ)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë”©ë™ëŒ•ë™ (ì „ììŒ)')}.mp3` }, { name: 'ë¬¸ì ì „ì†¡ìŒ(ë˜ë¡œë¡±)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë¬¸ì ì „ì†¡ìŒ(ë˜ë¡œë¡±)')}.mp3` }, { name: 'ë³µì‹± íƒ€ì´ë¨¸(ë•¡ë•¡ë•¡)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë³µì‹± í›ˆë ¨ íƒ€ì´ë¨¸ê°€ ìš¸ë¦¬ëŠ” ì†Œë¦¬ (ë•¡ë•¡ë•¡)')}.mp3` }, { name: 'ë¹„ë””ì˜¤ ë¹¨ë¦¬ê°ê¸° ì˜ˆëŠ¥ìŒ', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë¹„ë””ì˜¤ í…Œì´í”„ ë¹¨ë¦¬ê°ê¸° ì˜ˆëŠ¥ìŒ')}.mp3` }, { name: 'ë¾°ë¡œë¡±', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë¾°ë¡œë¡±')}.mp3` }, { name: 'íœ™ ë‚ ì¹´ë¡­ê²Œ ì§€ë‚˜ê°€ëŠ”', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('íœ™ ë‚ ì¹´ë¡­ê²Œ ì§€ë‚˜ê°€ëŠ”')}.mp3` }, { name: 'ì‹œí•œí­íƒ„ ì´ˆì‹œê³„ (timer)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì‹œí•œí­íƒ„ ì´ˆì‹œê³„ (timer)')}.mp3` }, { name: 'ì•ŒëŒ ì‹œê°„ ì¢…ë£Œ -2 (ì°¨ë¶„_ beep)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì•ŒëŒ ì‹œê°„ ì¢…ë£Œ -2 (ì°¨ë¶„_ beep)')}.mp3` }, { name: 'ì—˜ë¦¬ë² ì´í„° ë„ì°©ìŒ2 (ëµë™)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì—˜ë¦¬ë² ì´í„° ë„ì°©ìŒ2 (ëµë™)')}.mp3` }, { name: 'ìš• ê°€ë¦¬ëŠ” ì‚ì²˜ë¦¬', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ìš• ê°€ë¦¬ëŠ” ì‚ì²˜ë¦¬')}.mp3` }, { name: 'ì‘ì€ ì¹´ë©”ë¼ ì°°ì¹µ ì†Œë¦¬', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì‘ì€ ì¹´ë©”ë¼ ì°°ì¹µ ì†Œë¦¬')}.mp3` }, { name: 'ì €ë…ìˆ² (ê°œêµ¬ë¦¬, ê³¤ì¶©)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì €ë…ìˆ² (ê°œêµ¬ë¦¬ì™€ ê³¤ì¶©ìš¸ìŒì†Œë¦¬)')}.mp3` }, { name: 'í”Œë˜ë˜ ê±¸ì–´ê°€ëŠ” ì†Œë¦¬(ë½€ë³µ)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('í”Œë˜ë˜ ê±¸ì–´ê°€ëŠ” ì†Œë¦¬(ë½€ë³µ)')}.mp3` }, { name: 'ì²œì‚¬ì˜ ê°•ë¦¼', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì²œì‚¬ì˜ ê°•ë¦¼')}.mp3` }, { name: 'ê°œì„œ (ì² ì»¥ì¿µ)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ê°œì„œ (ì² ì»¥ì¿µ)')}.mp3` }, { name: 'ì»´í“¨í„° í‚¤ë³´ë“œ íƒ€ì', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì»´í“¨í„° í‚¤ë³´ë“œ íƒ€ì')}.mp3` }, { name: 'íƒ€ì´ë¨¸ (ì§¸ê¹ì§¸ê¹)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('íƒ€ì´ë¨¸ ì¬ëŠ” ì‹œê³„ìŒ(ì§¸ê¹ì§¸ê¹)')}.mp3` }, { name: 'í™©ë‹¹í•  ë•Œ (ë ìš”ì˜¹)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('í™©ë‹¹í•  ë•Œ íš¨ê³¼ìŒ (ë ìš”ì˜¹)')}.mp3` }, { name: 'Riser 1', url: 'https://sunsaktool-final.netlify.app/sfx/riser 1.wav' }, { name: 'Whoosh 1', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh1.mp3' }, { name: 'Whoosh 2', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh2.mp3' }, { name: 'Whoosh 3', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh3.wav' }, { name: 'Whoosh 4', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh4.mp3' }, { name: 'ë˜ë¡œë¡±', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë˜ë¡œë¡±')}.wav` }, { name: 'ë˜ì•„ì•™', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë˜ì•„ì•™')}.wav` }, { name: 'ë ë¡œë¡', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë ë¡œë¡')}.mp3` }, { name: 'ë ë¡±(ìŠˆí¼ë§ˆë¦¬ì˜¤)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë ë¡±_ìŠˆí¼ë§ˆë¦¬ì˜¤')}.mp3` }, { name: 'ë ë¦¬ë§', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë ë¦¬ë§')}.wav` }, { name: 'ë ë§ 1', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§1.wav' }, { name: 'ë ë§ 1ì´ˆ', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§1ì´ˆ.mp3' }, { name: 'ë ë§ 2', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§2.mp3' }, { name: 'ë ë§ 2ì´ˆ', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§2ì´ˆ.mp3' }, { name: 'ë ë§ 3', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§3.mp3' }, { name: 'ë ë§ 4', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§4.wav' }, { name: 'ëµ', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ëµ')}.mp3` }, { name: 'ë§ˆìš°ìŠ¤í´ë¦­(ë”¸ê¹)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë§ˆìš°ìŠ¤í´ë¦­_ë”¸ê¹')}.mp3` }, { name: 'ë¾°ì˜¥ 1', url: 'https://sunsaktool-final.netlify.app/sfx/ë¾°ì˜¥1.wav' }, { name: 'ë¾°ì˜¥ 2', url: 'https://sunsaktool-final.netlify.app/sfx/ë¾°ì˜¥2.mp3' }, { name: 'ë¾°ì˜¥ 3', url: 'https://sunsaktool-final.netlify.app/sfx/ë¾°ì˜¥3.wav' }, { name: 'ë½ 1ì´ˆ', url: 'https://sunsaktool-final.netlify.app/sfx/ë½1ì´ˆ.mp3' }, { name: 'ì‚ë¦¬ì‚ë¹…', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì‚ë¦¬ì‚ë¹…')}.mp3` }, { name: 'ì‚‘', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì‚‘')}.mp3` }, { name: 'ì…”í„°', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì…”í„°')}.wav` }, { name: 'ìŠ‰ 1ì´ˆ', url: 'https://sunsaktool-final.netlify.app/sfx/ìŠ‰1ì´ˆ.mp3' }, { name: 'ìŠ¤ìœ½', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ìŠ¤ìœ½')}.mp3` }, { name: 'ì˜ˆ!', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì˜ˆ!')}.mp3` }, { name: 'ì™€ìš°', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì™€ìš°')}.wav` }, { name: 'ì°°ì¹µ(ì†Œë¦¬)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì°°ì¹µ')}.wav` }, { name: 'ìºì„œ', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ìºì„œ')}.mp3` }, { name: 'í‚¤ë³´ë“œíƒ€ì´í•‘', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('í‚¤ë³´ë“œíƒ€ì´í•‘')}.mp3` }, { name: 'íˆ½', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('íˆ½')}.mp3` }, { name: 'í­ë°œ 1', url: 'https://sunsaktool-final.netlify.app/sfx/í­ë°œ1.mp3' }, { name: 'í­ë°œ 2', url: 'https://sunsaktool-final.netlify.app/sfx/í­ë°œ2.mp3' }, { name: 'í­ë°œ(í°)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('í­ë°œ_í°')}.mp3` }, { name: 'í›„ìš±', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('í›„ìš±')}.mp3` } ];

        let globalBGM = { url: null, volume: 0.3, startTime: 0, endTime: null };
        let scriptCards = [];
        let isPlaying = false;
        let ttsCache = new Map();
        let playbackCurrentIndex = 0;
        let selectedCardId = null;

        const cardContainer = document.getElementById('st-card-container');
        const playAllBtn = document.getElementById('st-btn-play-all');
        const ttsPlayer = document.getElementById('st-tts-player');
        const bgmPlayer = document.getElementById('st-bgm-player');
        const sfxPlayer = document.getElementById('st-sfx-player'); 
        const settingsPanel = document.getElementById('st-settings-panel');
        const addCardBtn = document.getElementById('st-btn-add-card');
        
        const addGptsBtn = document.getElementById('st-btn-add-gpts');
        const gptsModal = document.getElementById('st-modal-gpts');
        const gptsCancelBtn = document.getElementById('st-btn-gpts-cancel');
        const gptsConfirmBtn = document.getElementById('st-btn-gpts-confirm');
        const gptsTextarea = document.getElementById('st-gpts-textarea');

        let wavesurfer = null;

        // âœ¨ --- TTS í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼) --- âœ¨
        async function fetchTTS(text, cardId) {
            text = text.trim();
            if (!text) return null;
            const cacheKey = text; 
            if (ttsCache.has(cacheKey)) return ttsCache.get(cacheKey);
            showLoadingOnCard(cardId, true, 'ì„œë²„ì— ìš”ì²­ ì¤‘...');
            try {
                const response = await fetch('/.netlify/functions/create-tts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: text }) });
                if (!response.ok) { const errorResult = await response.json(); throw new Error(`[${response.status}] ${errorResult.error || 'ì„œë²„ ìš”ì²­ ì‹¤íŒ¨'}`); }
                const result = await response.json();
                const audioUrl = result.audioUrl;
                const duration = await getAudioDuration(audioUrl);
                const ttsData = { audioUrl, duration };
                ttsCache.set(cacheKey, ttsData);
                return ttsData;
            } catch (error) {
                console.error('TTS ìƒì„± ì˜¤ë¥˜:', error); alert(`ìŒì„± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); return null;
            } finally {
                showLoadingOnCard(cardId, false);
            }
        }
        
        // âœ¨ --- ì¹´ë“œ ì¶”ê°€ í•¨ìˆ˜ (ìŠ¤íƒ€ì¼ ê°ì²´ ì¶”ê°€) --- âœ¨
        function addScriptCard(text = '') {
            const cardId = `card-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
            const cardData = {
                id: cardId, text, duration: 0.5, imageUrl: null, audioUrl: null, ttsReady: false, sfxUrl: null,
                // âœ¨ ìœ„ì¹˜/í¬ê¸°/ìŠ¤íƒ€ì¼ ì €ì¥ì„ ìœ„í•œ ê°ì²´ ì¶”ê°€
                style: {
                    fontFamily: "'Noto Sans KR', sans-serif",
                    fontSize: '24px',
                    color: '#000000',
                },
                layout: {
                    text: { x: 0, y: 150, width: 330, height: 100 },
                    image: { x: 0, y: 20, width: 330, height: 185 }
                }
            };
            scriptCards.push(cardData);
            const cardEl = document.createElement('div'); cardEl.className = 'st-card'; cardEl.dataset.id = cardId; const sfxOptions = SFX_LIST.map(sfx => `<option value="${sfx.url || ''}">${sfx.name}</option>`).join('');
            cardEl.innerHTML = `<div class="st-card-header st-card-drag-handle"><span class="st-card-number"></span><button class="st-btn-delete-card">ğŸ—‘ï¸</button></div> <textarea placeholder="ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">${text}</textarea> <div class="st-card-footer"> <button class="st-play-clip-btn" title="ë¯¸ë¦¬ë“£ê¸°" disabled>â–¶ï¸</button> <span class="st-duration-label">íƒ€ì„ë¼ì¸ (---ì´ˆ)</span> <label class="st-action-btn" for="${cardId}-file">ì´ë¯¸ì§€</label> <input type="file" id="${cardId}-file" accept="image/*"> <select class="st-sfx-select" style="width: auto; margin-left: auto;">${sfxOptions}</select> </div>`;
            cardContainer.appendChild(cardEl);
            const fileInput = cardEl.querySelector(`#${cardId}-file`);
            fileInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { const reader = new FileReader(); reader.onload = (event) => { cardData.imageUrl = event.target.result; if (selectedCardId === cardId) { updatePreviewDisplay(); } }; reader.readAsDataURL(e.target.files[0]); } });
            cardEl.querySelector('.st-play-clip-btn').addEventListener('click', (e) => { e.stopPropagation(); if (isPlaying) stopPlayback(); if (cardData.ttsReady && cardData.audioUrl) { ttsPlayer.src = cardData.audioUrl; ttsPlayer.play(); } });
            cardEl.querySelector('.st-sfx-select').addEventListener('change', (e) => { cardData.sfxUrl = e.target.value || null; });
            const debouncedFetchAndUpdate = debounce(async (newText, id) => { const cardToUpdate = scriptCards.find(c => c.id === id); const ttsData = await fetchTTS(newText, id); if (ttsData && cardToUpdate) { cardToUpdate.duration = ttsData.duration; cardToUpdate.audioUrl = ttsData.audioUrl; cardToUpdate.ttsReady = true; const currentCardEl = document.querySelector(`.st-card[data-id="${id}"]`); if(currentCardEl) { currentCardEl.querySelector('.st-duration-label').textContent = `íƒ€ì„ë¼ì¸ (${ttsData.duration.toFixed(2)}ì´ˆ)`; currentCardEl.querySelector('.st-play-clip-btn').disabled = false; } updateTotalDuration(); } }, 800);
            cardEl.querySelector('textarea').addEventListener('input', (e) => { cardData.text = e.target.value; debouncedFetchAndUpdate(cardData.text, cardId); if (selectedCardId === cardId) { updatePreviewDisplay(); } });
            cardEl.querySelector('.st-btn-delete-card').addEventListener('click', (e) => { e.stopPropagation(); deleteCard(cardId); });
            cardEl.addEventListener('click', () => selectCard(cardId)); if (text) debouncedFetchAndUpdate(text, cardId); if (!selectedCardId) selectCard(cardId); updateCardNumbers();
        }

        // âœ¨ --- ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë ˆì´ì•„ì›ƒ ì ìš© ë¡œì§ ì¶”ê°€) --- âœ¨
        function updatePreviewDisplay() {
            // í—¤ë”, í”„ë¡œì íŠ¸ ì •ë³´ ë“± ê¸°ì¡´ ë¡œì§
            const headerEl = document.querySelector('.st-preview-header'); if (headerEl) { headerEl.textContent = document.getElementById('st-setting-header-text')?.value || ''; headerEl.style.backgroundColor = document.getElementById('st-setting-header-bg')?.value || '#e82c43'; headerEl.style.color = document.getElementById('st-setting-header-color')?.value || '#ffffff'; headerEl.style.fontFamily = document.getElementById('st-setting-header-font')?.value || 'GmarketSans'; headerEl.style.fontSize = (document.getElementById('st-setting-header-size')?.value || '24') + 'px'; }
            const titleEl = document.querySelector('.st-project-info .title'); if (titleEl) { titleEl.textContent = document.getElementById('st-setting-project-title')?.value || ''; titleEl.style.color = document.getElementById('st-setting-title-color')?.value || '#000'; }
            const metaEl = document.querySelector('.st-project-info span'); if (metaEl) { metaEl.textContent = `${document.getElementById('st-setting-project-author')?.value || ''} | ì¡°íšŒìˆ˜ ${Number(document.getElementById('st-setting-project-views')?.value || 0).toLocaleString()}`; metaEl.style.color = document.getElementById('st-setting-meta-color')?.value || '#555'; }
            
            // ì„ íƒëœ ì¹´ë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const card = scriptCards.find(c => c.id === selectedCardId);
            const textContainer = document.getElementById('st-preview-text-container');
            const imageContainer = document.getElementById('st-preview-image-container');
            const textEl = document.getElementById('st-preview-text');
            const imageEl = document.getElementById('st-preview-image');

            if (card) {
                // í…ìŠ¤íŠ¸ ë‚´ìš© ë° ìŠ¤íƒ€ì¼ ì ìš©
                textEl.textContent = card.text;
                Object.assign(textEl.style, card.style);

                // ì´ë¯¸ì§€ ë‚´ìš© ì ìš©
                if (card.imageUrl) {
                    imageEl.src = card.imageUrl;
                    imageContainer.style.display = 'block';
                } else {
                    imageContainer.style.display = 'none';
                }

                // âœ¨ ì €ì¥ëœ ë ˆì´ì•„ì›ƒ ì ìš© âœ¨
                const applyLayout = (el, layout) => {
                    el.style.width = `${layout.width}px`;
                    el.style.height = `${layout.height}px`;
                    el.style.transform = `translate(${layout.x}px, ${layout.y}px)`;
                    el.setAttribute('data-x', layout.x);
                    el.setAttribute('data-y', layout.y);
                };
                applyLayout(textContainer, card.layout.text);
                applyLayout(imageContainer, card.layout.image);

            } else {
                // ì„ íƒëœ ì¹´ë“œê°€ ì—†ì„ ë•Œ ê¸°ë³¸ ìƒíƒœ
                textEl.textContent = 'ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”.';
                imageContainer.style.display = 'none';
            }
        }
        
        // âœ¨ --- Interact.js ì´ˆê¸°í™” ë° ë¡œì§ --- âœ¨
        function initializeInteract() {
            const verticalGuide = document.querySelector('.snap-guide-v');
            const dropzone = document.querySelector('.st-script-display');
            
            const position = { x: 0, y: 0 };

            interact('.st-script-display > div')
                .draggable({
                    listeners: {
                        start(event) {
                            const rect = event.target.getBoundingClientRect();
                            position.x = parseFloat(event.target.getAttribute('data-x')) || 0;
                            position.y = parseFloat(event.target.getAttribute('data-y')) || 0;
                            event.target.classList.add('interactive-active');
                        },
                        move(event) {
                            position.x += event.dx;
                            position.y += event.dy;
                            event.target.style.transform = `translate(${position.x}px, ${position.y}px)`;

                            // âœ¨ ìŠ¤ë§ˆíŠ¸ ê°€ì´ë“œ ë¡œì§ âœ¨
                            const targetRect = event.target.getBoundingClientRect();
                            const dropzoneRect = dropzone.getBoundingClientRect();
                            const targetCenter = targetRect.left + targetRect.width / 2;
                            const dropzoneCenter = dropzoneRect.left + dropzoneRect.width / 2;

                            if (Math.abs(targetCenter - dropzoneCenter) < 5) { // 5px ì´ë‚´ë¡œ ê°€ê¹Œìš°ë©´
                                verticalGuide.style.left = `${dropzone.offsetWidth / 2}px`;
                                verticalGuide.style.display = 'block';
                                // ìŠ¤ëƒ…: ì‹¤ì œ ìœ„ì¹˜ ë³´ì •
                                position.x -= (targetCenter - dropzoneCenter);
                                event.target.style.transform = `translate(${position.x}px, ${position.y}px)`;
                            } else {
                                verticalGuide.style.display = 'none';
                            }
                        },
                        end(event) {
                            verticalGuide.style.display = 'none';
                            event.target.setAttribute('data-x', position.x);
                            event.target.setAttribute('data-y', position.y);
                            
                            // âœ¨ ë³€ê²½ëœ ìœ„ì¹˜ ì €ì¥ âœ¨
                            const card = scriptCards.find(c => c.id === selectedCardId);
                            const elType = event.target.id.includes('text') ? 'text' : 'image';
                            if (card) {
                                card.layout[elType].x = position.x;
                                card.layout[elType].y = position.y;
                            }
                        }
                    },
                    modifiers: [
                        interact.modifiers.restrictRect({
                            restriction: 'parent'
                        })
                    ]
                })
                .resizable({
                    edges: { top: true, left: true, bottom: true, right: true },
                    listeners: {
                        move: function (event) {
                            let { x, y } = event.target.dataset;
                            x = (parseFloat(x) || 0) + event.deltaRect.left;
                            y = (parseFloat(y) || 0) + event.deltaRect.top;

                            Object.assign(event.target.style, {
                                width: event.rect.width + 'px',
                                height: event.rect.height + 'px',
                                transform: 'translate(' + x + 'px,' + y + 'px)'
                            });

                            Object.assign(event.target.dataset, { x, y });
                        },
                        end(event) {
                            // âœ¨ ë³€ê²½ëœ í¬ê¸° ì €ì¥ âœ¨
                             const card = scriptCards.find(c => c.id === selectedCardId);
                             const elType = event.target.id.includes('text') ? 'text' : 'image';
                             if (card) {
                                card.layout[elType].width = event.rect.width;
                                card.layout[elType].height = event.rect.height;
                             }
                        }
                    },
                    modifiers: [
                        interact.modifiers.restrictSize({
                           min: { width: 50, height: 30 }
                        }),
                         interact.modifiers.restrictRect({
                            restriction: 'parent'
                        })
                    ]
                });
            
            // ì»¨í…Œì´ë„ˆ í´ë¦­ ì‹œ ëª¨ë“  active ìƒíƒœ í•´ì œ
            dropzone.addEventListener('click', (event) => {
                if (event.target === dropzone) {
                    document.querySelectorAll('.interactive-active').forEach(el => el.classList.remove('interactive-active'));
                }
            });
        }
        
        function selectCard(cardId, fromPlayback = false) {
            if (isPlaying && !fromPlayback) stopPlayback(); 
            selectedCardId = cardId; 
            document.querySelectorAll('.st-card').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.interactive-active').forEach(el => el.classList.remove('interactive-active'));
            const cardEl = document.querySelector(`.st-card[data-id="${cardId}"]`); 
            if (cardEl) { 
                cardEl.classList.add('active'); 
                if (!fromPlayback) cardEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                updateScriptStyleControls(); 
                updatePreviewDisplay(); 
            } else { 
                updatePreviewDisplay(); 
            }
        }

        // --- ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ê±°ì˜ ë™ì¼í•©ë‹ˆë‹¤ ---
        const debounce = (callback, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => callback(...args), delay); }; };
        const getAudioDuration = (url) => new Promise(resolve => { const audio = new Audio(); audio.onloadedmetadata = () => resolve(audio.duration); audio.src = url; });
        function renderControls() { const fontOptions = FONT_LIST.map(font => `<option value="${font.value}" style="font-family: ${font.value};">${font.name}</option>`).join(''); const bgmOptions = BGM_LIST.map(bgm => `<option value="${bgm.url}">${bgm.name}</option>`).join(''); settingsPanel.innerHTML = ` <div class="st-accordion-item active"><div class="st-accordion-header">í—¤ë” ìŠ¤íƒ€ì¼</div><div class="st-accordion-content"> <div class="st-control-group"><label>í—¤ë” í…ìŠ¤íŠ¸</label><input type="text" id="st-setting-header-text" value="ì°ì‘ˆ"></div> <div class="st-flex-group"> <div><label>ë°°ê²½ ìƒ‰ìƒ</label><input type="color" id="st-setting-header-bg" value="#e82c43"></div> <div><label>ê¸€ì ìƒ‰ìƒ</label><input type="color" id="st-setting-header-color" value="#FFFFFF"></div> </div> <div class="st-flex-group"> <div><label>í°íŠ¸</label><select id="st-setting-header-font">${fontOptions}</select></div> <div><label>í¬ê¸°</label><input type="number" id="st-setting-header-size" value="24"></div> </div> </div></div> <div class="st-accordion-item"><div class="st-accordion-header">ìŠ¤í¬ë¦½íŠ¸ ìŠ¤íƒ€ì¼</div><div class="st-accordion-content"><div class="st-control-group"><label>í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label><input type="color" id="st-setting-script-color" value="#000000"></div><div class="st-flex-group"><div><label>í°íŠ¸</label><select id="st-setting-script-font">${fontOptions}</select></div><div><label>í¬ê¸°</label><input type="number" id="st-setting-script-size" value="24"></div></div></div></div> <div class="st-accordion-item"><div class="st-accordion-header">í”„ë¡œì íŠ¸ ì •ë³´</div><div class="st-accordion-content"><div class="st-control-group"><label>ì œëª©</label><input type="text" id="st-setting-project-title" value=""></div><div class="st-control-group"><label>ì‘ì„±ì</label><input type="text" id="st-setting-project-author" value=""></div><div class="st-control-group"><label>ì¡°íšŒìˆ˜</label><input type="number" id="st-setting-project-views" value="0"></div><div class="st-flex-group"><div><label>ì œëª© ìƒ‰ìƒ</label><input type="color" id="st-setting-title-color" value="#000000"></div><div><label>ì‘ì„±ì/ì¡°íšŒìˆ˜ ìƒ‰ìƒ</label><input type="color" id="st-setting-meta-color" value="#555555"></div></div></div></div> <div class="st-accordion-item"><div class="st-accordion-header">ë°°ê²½ìŒì•… ì„¤ì •</div><div class="st-accordion-content"><div class="st-control-group"><label>ì „ì²´ ë°°ê²½ìŒì•… ì„ íƒ</label><select id="st-setting-global-bgm">${bgmOptions}</select></div><div class="st-control-group"><label>BGM ë³¼ë¥¨</label><input type="range" id="st-setting-global-bgm-volume" min="0" max="1" step="0.01" value="${globalBGM.volume}"></div></div></div>`; document.querySelectorAll('#st-settings-panel input, #st-settings-panel select').forEach(el => { if (el.id.includes('script')) { el.addEventListener('input', applyScriptStylesToSelectedCard); } else { el.addEventListener('input', updatePreviewDisplay); } }); document.querySelectorAll('.st-accordion-header').forEach(h => h.addEventListener('click', () => h.parentElement.classList.toggle('active'))); }
        function deleteCard(cardId) { const cardIndex = scriptCards.findIndex(c => c.id === cardId); if(cardIndex === -1) return; scriptCards.splice(cardIndex, 1); document.querySelector(`.st-card[data-id="${cardId}"]`).remove(); if (selectedCardId === cardId) { selectedCardId = null; if(scriptCards.length > 0) { const nextIndex = Math.max(0, cardIndex - 1); if (scriptCards[nextIndex]) selectCard(scriptCards[nextIndex].id); } else { updatePreviewDisplay(); } } updateTotalDuration(); updateCardNumbers(); }
        function updateCardNumbers() { document.querySelectorAll('.st-card').forEach((card, index) => { card.querySelector('.st-card-number').textContent = index + 1; }); }
        function updateTotalDuration() { const total = scriptCards.reduce((sum, card) => sum + (card.duration || 0.5), 0); }
        function showLoadingOnCard(cardId, show, message = 'ìŒì„± ìƒì„± ì¤‘...') { const cardEl = document.querySelector(`.st-card[data-id="${cardId}"]`); if (!cardEl) return; let overlay = cardEl.querySelector('.st-card-loading'); if (show) { if (!overlay) { overlay = document.createElement('div'); overlay.className = 'st-card-loading'; cardEl.appendChild(overlay); } overlay.textContent = message; } else { if (overlay) overlay.remove(); } }
        function updateScriptStyleControls() { const card = scriptCards.find(c => c.id === selectedCardId); if (!card) return; document.getElementById('st-setting-script-color').value = card.style?.color || '#000000'; document.getElementById('st-setting-script-font').value = card.style?.fontFamily || "'Noto Sans KR', sans-serif"; document.getElementById('st-setting-script-size').value = (card.style?.fontSize || '24px').replace('px',''); }
        function applyScriptStylesToSelectedCard() { const card = scriptCards.find(c => c.id === selectedCardId); if (!card) return; card.style = { ...card.style, color: document.getElementById('st-setting-script-color').value, fontFamily: document.getElementById('st-setting-script-font').value, fontSize: document.getElementById('st-setting-script-size').value + 'px' }; updatePreviewDisplay(); }
        function playBGM(bgmData = globalBGM) { if (bgmData && bgmData.url) { if (bgmPlayer.src !== bgmData.url) bgmPlayer.src = bgmData.url; bgmPlayer.volume = globalBGM.volume; bgmPlayer.currentTime = bgmData.startTime || 0; bgmPlayer.play().catch(e => console.error("BGM Playback Error:", e)); } else { bgmPlayer.pause(); } }
        bgmPlayer.addEventListener('timeupdate', () => { if (!isPlaying) return; if (globalBGM.endTime && bgmPlayer.currentTime >= globalBGM.endTime) { bgmPlayer.currentTime = globalBGM.startTime || 0; } });
        function togglePlay() { isPlaying ? stopPlayback() : startPlayback(); }
        function startPlayback() { const unready = scriptCards.some(c => !c.ttsReady && c.text.trim()); if (unready) return alert('ì•„ì§ ìŒì„± ìƒì„±ì´ ì™„ë£Œë˜ì§€ ì•Šì€ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.'); if (scriptCards.length === 0) return; isPlaying = true; playAllBtn.textContent = 'âšâš'; playBGM(); playCardByIndex(0); }
        function stopPlayback() { isPlaying = false; playAllBtn.textContent = 'â–¶'; ttsPlayer.pause(); bgmPlayer.pause(); sfxPlayer.pause(); }
        function playCardByIndex(index) { if (index >= scriptCards.length || !isPlaying) { stopPlayback(); return; } playbackCurrentIndex = index; const card = scriptCards[index]; selectCard(card.id, true); if (card.sfxUrl) { sfxPlayer.src = card.sfxUrl; sfxPlayer.play(); } setTimeout(() => { if (isPlaying && playbackCurrentIndex === index) { ttsPlayer.src = card.audioUrl; ttsPlayer.play(); } }, 30); ttsPlayer.onended = () => playCardByIndex(index + 1); }
        function setupGptsModal() { addGptsBtn.addEventListener('click', () => gptsModal.classList.add('visible')); function closeModal() { gptsModal.classList.remove('visible'); gptsTextarea.value = ''; } gptsCancelBtn.addEventListener('click', closeModal); gptsModal.addEventListener('click', (e) => { if (e.target === gptsModal) closeModal(); }); gptsConfirmBtn.addEventListener('click', () => { const text = gptsTextarea.value.trim(); if (!text) return; const lines = text.split(/\n\s*\n/).filter(line => line.trim() !== ''); lines.forEach(line => addScriptCard(line.trim())); closeModal(); if(lines.length > 0 && scriptCards.length > 0) { const firstNewCardId = scriptCards[scriptCards.length - lines.length].id; selectCard(firstNewCardId); } }); }
        function setupExportButton() { const exportBtn = document.getElementById('st-btn-export-video'); if (!exportBtn) return; exportBtn.addEventListener('click', async () => { if (scriptCards.some(c => !c.ttsReady && c.text.trim())) return alert('ì•„ì§ ìŒì„± ìƒì„±ì´ ì™„ë£Œë˜ì§€ ì•Šì€ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤. ëª¨ë‘ ìƒì„±ëœ í›„ ì‹œë„í•´ì£¼ì„¸ìš”.'); if (scriptCards.length === 0) return alert('ì¶œë ¥í•  ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'); exportBtn.disabled = true; exportBtn.textContent = 'ë Œë”ë§ ìš”ì²­ ì¤‘...'; try { const projectData = { resolution: { width: 1080, height: 1920 }, fps: 60, styles: { header: { text: document.getElementById('st-setting-header-text')?.value, backgroundColor: document.getElementById('st-setting-header-bg')?.value, color: document.getElementById('st-setting-header-color')?.value, fontFamily: document.getElementById('st-setting-header-font')?.value, fontSize: parseInt(document.getElementById('st-setting-header-size')?.value) }, projectInfo: { title: document.getElementById('st-setting-project-title')?.value, author: document.getElementById('st-setting-project-author')?.value, views: document.getElementById('st-setting-project-views')?.value, titleColor: document.getElementById('st-setting-title-color')?.value, metaColor: document.getElementById('st-setting-meta-color')?.value } }, bgm: { url: globalBGM.url, volume: globalBGM.volume, startTime: globalBGM.startTime, endTime: globalBGM.endTime }, scenes: scriptCards.map(card => ({ text: card.text, duration: card.duration, audioUrl: card.audioUrl, imageUrl: card.imageUrl, sfxUrl: card.sfxUrl, style: card.style, layout: card.layout })) }; const response = await fetch('/.netlify/functions/render-video', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(projectData) }); if (!response.ok) { const errorResult = await response.json(); throw new Error(errorResult.error || 'ì„œë²„ì—ì„œ ë Œë”ë§ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); } const result = await response.json(); alert(`ì˜ìƒ ë Œë”ë§ ìš”ì²­ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤! (ì‘ì—… ID: ${result.jobId})\n\n(ì£¼ì˜: ì‹¤ì œ ë Œë”ë§ ê¸°ëŠ¥ì€ ì„œë²„ì— êµ¬í˜„ì´ í•„ìš”í•©ë‹ˆë‹¤.)`); } catch (error) { console.error('ì˜ìƒ ì¶œë ¥ ìš”ì²­ ì˜¤ë¥˜:', error); alert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); } finally { exportBtn.disabled = false; exportBtn.textContent = 'ğŸ¬ ì˜ìƒ ì¶œë ¥ (1080p)'; } }); }
        
        function initialize() {
            renderControls(); 
            updatePreviewDisplay(); 
            addCardBtn.addEventListener('click', () => addScriptCard('')); 
            playAllBtn.addEventListener('click', togglePlay);
            setupGptsModal();
            setupExportButton();
            // BGM í¸ì§‘ê¸° ë¡œì§ì€ ìƒëµ
            document.getElementById('st-setting-global-bgm-volume').addEventListener('input', (e) => { globalBGM.volume = parseFloat(e.target.value); bgmPlayer.volume = globalBGM.volume; });
            new Sortable(cardContainer, { animation: 150, handle: '.st-card-drag-handle', onEnd: function(evt) { const { oldIndex, newIndex } = evt; const [movedItem] = scriptCards.splice(oldIndex, 1); scriptCards.splice(newIndex, 0, movedItem); updateCardNumbers(); } });
            
            // âœ¨ interact.js ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ âœ¨
            initializeInteract();
            
            addScriptCard('SunsakToolì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!');
        }
        
        initialize();
    });
    </script>
</body>
</html>
