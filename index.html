<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunsakTool - 숏폼 영상 제작기</title>
    <!-- Google Fonts Link -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Gaegu&family=Gowun+Batang&family=Hi+Melody&family=IBM+Plex+Sans+KR&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@400;700&family=Noto+Serif+KR&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gmarket-sans-font@1.0.0/css/gmarket-sans.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

    <style>
        /* 기본 스타일, 레이아웃 등 */
        :root { --st-primary-color: #e82c43; --st-bg-color: #f8f9fa; --st-panel-bg: #fff; --st-border-color: #dee2e6; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--st-bg-color); color: #333; display: flex; height: 100vh; overflow: hidden; }
        .st-main-container { display: flex; width: 100%; height: 100%; }
        .st-script-panel, .st-preview-wrapper, .st-settings-panel-wrapper { padding: 15px; background-color: var(--st-panel-bg); display: flex; flex-direction: column; }
        .st-script-panel { width: 30%; border-right: 1px solid var(--st-border-color); }
        .st-preview-wrapper { flex-grow: 1; align-items: center; justify-content: flex-start; background: #f0f0f0; }
        .st-settings-panel-wrapper { width: 280px; border-left: 1px solid var(--st-border-color); overflow-y: auto; }

        /* 공통 버튼 및 컨트롤 */
        button, .st-action-btn { cursor: pointer; border: 1px solid var(--st-border-color); background: #fff; padding: 8px 12px; border-radius: 4px; transition: background-color 0.2s; }
        button:hover, .st-action-btn:hover { background-color: #f1f3f5; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 8px; border: 1px solid var(--st-border-color); border-radius: 4px; }
        
        /* 스크립트 카드 부분 */
        .st-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #st-card-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .st-card { border: 1px solid var(--st-border-color); border-radius: 6px; margin-bottom: 10px; background-color: #fff; position: relative; }
        .st-card.active { border-color: var(--st-primary-color); box-shadow: 0 0 5px rgba(232, 44, 67, 0.5); }
        .st-card-header { display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; padding: 5px 10px; border-bottom: 1px solid var(--st-border-color); }
        .st-card-drag-handle { cursor: move; }
        .st-card textarea { width: 100%; height: 80px; border: none; padding: 10px; resize: vertical; }
        .st-card-footer { display: flex; align-items: center; padding: 5px 10px; gap: 10px; font-size: 12px; color: #868e96; }
        input[type="file"] { display: none; }
        .st-card-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 10; }

        /* 미리보기 패널 */
        #st-preview-panel { width: 360px; height: 640px; background-color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; margin-top: 20px; }
        .st-preview-header { padding: 12px; text-align: center; color: white; font-weight: bold; flex-shrink: 0; }
        .st-preview-content { flex-grow: 1; display: flex; flex-direction: column; padding: 15px; position: relative; }
        .st-project-info { text-align: center; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        .st-project-info .title { font-size: 20px; font-weight: bold; }
        
        /* ✨ 인터랙션 기능 관련 스타일 ✨ */
        .st-script-display { flex-grow: 1; position: relative; /* 자식 요소의 기준점 */ overflow: hidden; background: #fdfdfd; border: 1px dashed #ccc; }
        #st-preview-text-container, #st-preview-image-container {
            position: absolute; /* 자유로운 위치 조정을 위해 */
            cursor: move;
            touch-action: none; /* interact.js 권장사항 */
            min-width: 50px;
            min-height: 20px;
            border: 2px solid transparent;
        }
        #st-preview-text-container.interactive-active, #st-preview-image-container.interactive-active {
            border-color: var(--st-primary-color);
            z-index: 100;
        }
        #st-preview-text { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 10px; white-space: pre-wrap; word-break: break-all; }
        #st-preview-image { width: 100%; height: 100%; object-fit: cover; }
        .snap-guide-v { position: absolute; top: 0; bottom: 0; width: 1px; background-color: var(--st-primary-color); display: none; z-index: 999; }

        /* 설정 패널 (Accordion) */
        .st-accordion-item { border-bottom: 1px solid var(--st-border-color); }
        .st-accordion-header { background: #f8f9fa; padding: 10px; cursor: pointer; font-weight: bold; }
        .st-accordion-content { padding: 15px; display: none; }
        .st-accordion-item.active .st-accordion-content { display: block; }
        .st-control-group, .st-flex-group { margin-bottom: 15px; }
        .st-flex-group { display: flex; gap: 10px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; }

        /* 모달 스타일 */
        .st-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .st-modal.visible { display: flex; }
        .st-modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; }
        .st-modal-content h2 { margin-bottom: 15px; }
        .st-modal-content textarea { height: 200px; }
        .st-modal-footer { margin-top: 15px; text-align: right; }
        .st-modal-footer button { margin-left: 10px; }
    </style>
</head>
<body>

    <audio id="st-tts-player"></audio>
    <audio id="st-bgm-player" loop></audio>
    <audio id="st-sfx-player"></audio>
    
    <div class="st-main-container">
        <!-- 스크립트 패널 -->
        <div class="st-script-panel">
            <div class="st-panel-header">
                <h2>스크립트 목록</h2>
                <div>
                    <button id="st-btn-add-gpts">GPTs</button>
                    <button id="st-btn-add-card">추가 +</button>
                </div>
            </div>
            <div id="st-card-container"></div>
        </div>

        <!-- 미리보기 패널 -->
        <div class="st-preview-wrapper">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button id="st-btn-play-all">▶ 전체 재생</button>
                <button id="st-btn-export-video">🎬 영상 출력 (1080p)</button>
            </div>
            <div id="st-preview-panel">
                 <div class="st-preview-header"></div>
                 <div class="st-preview-content">
                     <div class="st-project-info">
                         <div class="title"></div>
                         <span></span>
                     </div>
                     <div class="st-script-display">
                        <!-- 스마트 가이드 라인 -->
                        <div class="snap-guide-v"></div>
                        
                        <!-- 인터랙션 대상 요소들 -->
                        <div id="st-preview-image-container">
                            <img id="st-preview-image">
                        </div>
                        <div id="st-preview-text-container">
                            <div id="st-preview-text"></div>
                        </div>
                     </div>
                 </div>
            </div>
        </div>

        <!-- 설정 패널 -->
        <div class="st-settings-panel-wrapper">
            <div id="st-settings-panel"></div>
        </div>
    </div>

    <!-- GPTs 스크립트 추가 모달 -->
    <div id="st-modal-gpts" class="st-modal">
        <div class="st-modal-content">
            <h2>GPTs 스크립트 붙여넣기</h2>
            <p style="font-size:14px; color:#666; margin-bottom:10px;">GPTs에서 생성된 스크립트 전체를 복사하여 아래에 붙여넣으세요. 빈 줄을 기준으로 카드가 자동으로 나뉩니다.</p>
            <textarea id="st-gpts-textarea" placeholder="여기에 스크립트 붙여넣기..."></textarea>
            <div class="st-modal-footer">
                <button id="st-btn-gpts-cancel">취소</button>
                <button id="st-btn-gpts-confirm" style="background-color: var(--st-primary-color); color: white;">확인</button>
            </div>
        </div>
    </div>
    
    <!-- BGM 편집기 모달 -->
    <div id="st-modal-bgm" class="st-modal">
        <!-- BGM 편집기 UI는 제공된 코드에 없어서 생략합니다. 로직은 유지됩니다. -->
    </div>


    <!-- ✨ 라이브러리 스크립트 ✨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.4.0/wavesurfer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.4.0/plugin/wavesurfer.regions.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- ✨ interact.js 라이브러리 추가 ✨ -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // 🚨 API 키 관련 설정이 모두 제거되었습니다.
        
        const FONT_LIST = [ { name: '프리텐다드 (본문용 추천)', value: 'Pretendard' }, { name: 'Noto Sans KR (기본 고딕)', value: "'Noto Sans KR', sans-serif" }, { name: 'G마켓 산스 (개성있는 제목)', value: 'GmarketSans' }, { name: 'IBM Plex Sans KR (모던한 고딕)', value: "'IBM Plex Sans KR', sans-serif" }, { name: 'Do Hyeon (레트로 제목)', value: "'Do Hyeon', sans-serif" }, { name: '나눔명조 (감성적인 본문)', value: "'Nanum Myeongjo', serif" }, { name: '고운 바탕 (부드러운 명조)', value: "'Gowun Batang', serif" }, { name: 'Black Han Sans (강력한 제목)', value: "'Black Han Sans', sans-serif" }, { name: '개구 (귀여운 손글씨)', value: "'Gaegu', cursive" }, { name: 'Hi Melody (아기자기 손글씨)', value: "'Hi Melody', cursive" }, { name: 'Noto Serif KR (정갈한 명조)', value: "'Noto Serif KR', serif" }, { name: '스포카 한 산스 네오 (깔끔한 본문)', value: "'Spoqa Han Sans Neo', sans-serif" }, { name: '독도 (거친 붓글씨)', value: "'Dokdo', cursive" }, ];
        const BGM_LIST = [ { name: '선택 안함', url: '' }, { name: 'big-cafe', url: 'https://sunsaktool-final.netlify.app/big-cafe.mp3' }, { name: 'blue-jacket', url: 'https://sunsaktool-final.netlify.app/blue-jacket.mp3' }, { name: 'cute-puppy', url: 'https://sunsaktool-final.netlify.app/cute-puppy.mp3' }, { name: 'laughter-in-the-breeze', url: 'https://sunsaktool-final.netlify.app/laughter-in-the-breeze-_happy_.mp3' }, { name: 'murder-in-my-mind', url: 'https://sunsaktool-final.netlify.app/murder-in-my-mind.mp3' }, { name: 'smiley-composure', url: 'https://sunsaktool-final.netlify.app/smiley-composure.mp3' }, { name: 'spider', url: 'https://sunsaktool-final.netlify.app/spider.mp3' }, { name: 'white-color', url: 'https://sunsaktool-final.netlify.app/white-color.mp3' } ];
        const SFX_LIST = [ { name: '효과음 없음', url: '' }, { name: '뾱 (물방울)', url: `https://sunsaktool-final.netlify.app/sfx/062_${encodeURIComponent('뾱 (물방울)')}.mp3` }, { name: '찰칵 (카메라)', url: `https://sunsaktool-final.netlify.app/sfx/078_${encodeURIComponent('찰칵 (카메라)')}.mp3` }, { name: '기어 1', url: 'https://sunsaktool-final.netlify.app/sfx/gears 1.wav' }, { name: '게임클리어 (고음)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('게임클리어 (고음)')}.mp3` }, { name: '긍정적 마법 사용', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('긍정적 마법 사용')}.mp3` }, { name: '깨달음(뾰봉)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('깨달음을 얻었을 때(뾰봉)')}.mp3` }, { name: '놀람 반전', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('놀람 반전')}.mp3` }, { name: '다음 장면전환(뾰로롱)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('다음 장면전환(뾰로롱)')}.mp3` }, { name: '넘어가는 맑은 소리(띠링~)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('다음으로 넘어가는 맑은 소리(띠링~)')}.mp3` }, { name: '동전먹는소리 2연속(중음)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('동전먹는소리 2연속(중음)')}.mp3` }, { name: '딩동댕동 (전자음)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('딩동댕동 (전자음)')}.mp3` }, { name: '문자 전송음(또로롱)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('문자 전송음(또로롱)')}.mp3` }, { name: '복싱 타이머(땡땡땡)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('복싱 훈련 타이머가 울리는 소리 (땡땡땡)')}.mp3` }, { name: '비디오 빨리감기 예능음', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('비디오 테이프 빨리감기 예능음')}.mp3` }, { name: '뾰로롱', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('뾰로롱')}.mp3` }, { name: '휙 날카롭게 지나가는', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('휙 날카롭게 지나가는')}.mp3` }, { name: '시한폭탄 초시계 (timer)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('시한폭탄 초시계 (timer)')}.mp3` }, { name: '알람 시간 종료 -2 (차분_ beep)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('알람 시간 종료 -2 (차분_ beep)')}.mp3` }, { name: '엘리베이터 도착음2 (띵동)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('엘리베이터 도착음2 (띵동)')}.mp3` }, { name: '욕 가리는 삐처리', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('욕 가리는 삐처리')}.mp3` }, { name: '작은 카메라 찰칵 소리', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('작은 카메라 찰칵 소리')}.mp3` }, { name: '저녁숲 (개구리, 곤충)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('저녁숲 (개구리와 곤충울음소리)')}.mp3` }, { name: '플래래 걸어가는 소리(뽀복)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('플래래 걸어가는 소리(뽀복)')}.mp3` }, { name: '천사의 강림', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('천사의 강림')}.mp3` }, { name: '개서 (철컥쿵)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('개서 (철컥쿵)')}.mp3` }, { name: '컴퓨터 키보드 타자', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('컴퓨터 키보드 타자')}.mp3` }, { name: '타이머 (째깍째깍)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('타이머 재는 시계음(째깍째깍)')}.mp3` }, { name: '황당할 때 (띠요옹)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('황당할 때 효과음 (띠요옹)')}.mp3` }, { name: 'Riser 1', url: 'https://sunsaktool-final.netlify.app/sfx/riser 1.wav' }, { name: 'Whoosh 1', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh1.mp3' }, { name: 'Whoosh 2', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh2.mp3' }, { name: 'Whoosh 3', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh3.wav' }, { name: 'Whoosh 4', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh4.mp3' }, { name: '또로롱', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('또로롱')}.wav` }, { name: '또아앙', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('또아앙')}.wav` }, { name: '띠로록', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('띠로록')}.mp3` }, { name: '띠롱(슈퍼마리오)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('띠롱_슈퍼마리오')}.mp3` }, { name: '띠리링', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('띠리링')}.wav` }, { name: '띠링 1', url: 'https://sunsaktool-final.netlify.app/sfx/띠링1.wav' }, { name: '띠링 1초', url: 'https://sunsaktool-final.netlify.app/sfx/띠링1초.mp3' }, { name: '띠링 2', url: 'https://sunsaktool-final.netlify.app/sfx/띠링2.mp3' }, { name: '띠링 2초', url: 'https://sunsaktool-final.netlify.app/sfx/띠링2초.mp3' }, { name: '띠링 3', url: 'https://sunsaktool-final.netlify.app/sfx/띠링3.mp3' }, { name: '띠링 4', url: 'https://sunsaktool-final.netlify.app/sfx/띠링4.wav' }, { name: '띵', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('띵')}.mp3` }, { name: '마우스클릭(딸깍)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('마우스클릭_딸깍')}.mp3` }, { name: '뾰옥 1', url: 'https://sunsaktool-final.netlify.app/sfx/뾰옥1.wav' }, { name: '뾰옥 2', url: 'https://sunsaktool-final.netlify.app/sfx/뾰옥2.mp3' }, { name: '뾰옥 3', url: 'https://sunsaktool-final.netlify.app/sfx/뾰옥3.wav' }, { name: '뽁 1초', url: 'https://sunsaktool-final.netlify.app/sfx/뽁1초.mp3' }, { name: '삐리삐빅', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('삐리삐빅')}.mp3` }, { name: '삑', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('삑')}.mp3` }, { name: '셔터', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('셔터')}.wav` }, { name: '슉 1초', url: 'https://sunsaktool-final.netlify.app/sfx/슉1초.mp3' }, { name: '스윽', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('스윽')}.mp3` }, { name: '예!', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('예!')}.mp3` }, { name: '와우', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('와우')}.wav` }, { name: '찰칵(소리)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('찰칵')}.wav` }, { name: '캐서', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('캐서')}.mp3` }, { name: '키보드타이핑', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('키보드타이핑')}.mp3` }, { name: '툽', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('툽')}.mp3` }, { name: '폭발 1', url: 'https://sunsaktool-final.netlify.app/sfx/폭발1.mp3' }, { name: '폭발 2', url: 'https://sunsaktool-final.netlify.app/sfx/폭발2.mp3' }, { name: '폭발(큰)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('폭발_큰')}.mp3` }, { name: '후욱', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('후욱')}.mp3` } ];

        let globalBGM = { url: null, volume: 0.3, startTime: 0, endTime: null };
        let scriptCards = [];
        let isPlaying = false;
        let ttsCache = new Map();
        let playbackCurrentIndex = 0;
        let selectedCardId = null;

        const cardContainer = document.getElementById('st-card-container');
        const playAllBtn = document.getElementById('st-btn-play-all');
        const ttsPlayer = document.getElementById('st-tts-player');
        const bgmPlayer = document.getElementById('st-bgm-player');
        const sfxPlayer = document.getElementById('st-sfx-player'); 
        const settingsPanel = document.getElementById('st-settings-panel');
        const addCardBtn = document.getElementById('st-btn-add-card');
        
        const addGptsBtn = document.getElementById('st-btn-add-gpts');
        const gptsModal = document.getElementById('st-modal-gpts');
        const gptsCancelBtn = document.getElementById('st-btn-gpts-cancel');
        const gptsConfirmBtn = document.getElementById('st-btn-gpts-confirm');
        const gptsTextarea = document.getElementById('st-gpts-textarea');

        let wavesurfer = null;

        // ✨ --- TTS 함수 (기존과 동일) --- ✨
        async function fetchTTS(text, cardId) {
            text = text.trim();
            if (!text) return null;
            const cacheKey = text; 
            if (ttsCache.has(cacheKey)) return ttsCache.get(cacheKey);
            showLoadingOnCard(cardId, true, '서버에 요청 중...');
            try {
                const response = await fetch('/.netlify/functions/create-tts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: text }) });
                if (!response.ok) { const errorResult = await response.json(); throw new Error(`[${response.status}] ${errorResult.error || '서버 요청 실패'}`); }
                const result = await response.json();
                const audioUrl = result.audioUrl;
                const duration = await getAudioDuration(audioUrl);
                const ttsData = { audioUrl, duration };
                ttsCache.set(cacheKey, ttsData);
                return ttsData;
            } catch (error) {
                console.error('TTS 생성 오류:', error); alert(`음성 생성 중 오류가 발생했습니다: ${error.message}`); return null;
            } finally {
                showLoadingOnCard(cardId, false);
            }
        }
        
        // ✨ --- 카드 추가 함수 (스타일 객체 추가) --- ✨
        function addScriptCard(text = '') {
            const cardId = `card-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
            const cardData = {
                id: cardId, text, duration: 0.5, imageUrl: null, audioUrl: null, ttsReady: false, sfxUrl: null,
                // ✨ 위치/크기/스타일 저장을 위한 객체 추가
                style: {
                    fontFamily: "'Noto Sans KR', sans-serif",
                    fontSize: '24px',
                    color: '#000000',
                },
                layout: {
                    text: { x: 0, y: 150, width: 330, height: 100 },
                    image: { x: 0, y: 20, width: 330, height: 185 }
                }
            };
            scriptCards.push(cardData);
            const cardEl = document.createElement('div'); cardEl.className = 'st-card'; cardEl.dataset.id = cardId; const sfxOptions = SFX_LIST.map(sfx => `<option value="${sfx.url || ''}">${sfx.name}</option>`).join('');
            cardEl.innerHTML = `<div class="st-card-header st-card-drag-handle"><span class="st-card-number"></span><button class="st-btn-delete-card">🗑️</button></div> <textarea placeholder="스크립트를 입력하세요...">${text}</textarea> <div class="st-card-footer"> <button class="st-play-clip-btn" title="미리듣기" disabled>▶️</button> <span class="st-duration-label">타임라인 (---초)</span> <label class="st-action-btn" for="${cardId}-file">이미지</label> <input type="file" id="${cardId}-file" accept="image/*"> <select class="st-sfx-select" style="width: auto; margin-left: auto;">${sfxOptions}</select> </div>`;
            cardContainer.appendChild(cardEl);
            const fileInput = cardEl.querySelector(`#${cardId}-file`);
            fileInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { const reader = new FileReader(); reader.onload = (event) => { cardData.imageUrl = event.target.result; if (selectedCardId === cardId) { updatePreviewDisplay(); } }; reader.readAsDataURL(e.target.files[0]); } });
            cardEl.querySelector('.st-play-clip-btn').addEventListener('click', (e) => { e.stopPropagation(); if (isPlaying) stopPlayback(); if (cardData.ttsReady && cardData.audioUrl) { ttsPlayer.src = cardData.audioUrl; ttsPlayer.play(); } });
            cardEl.querySelector('.st-sfx-select').addEventListener('change', (e) => { cardData.sfxUrl = e.target.value || null; });
            const debouncedFetchAndUpdate = debounce(async (newText, id) => { const cardToUpdate = scriptCards.find(c => c.id === id); const ttsData = await fetchTTS(newText, id); if (ttsData && cardToUpdate) { cardToUpdate.duration = ttsData.duration; cardToUpdate.audioUrl = ttsData.audioUrl; cardToUpdate.ttsReady = true; const currentCardEl = document.querySelector(`.st-card[data-id="${id}"]`); if(currentCardEl) { currentCardEl.querySelector('.st-duration-label').textContent = `타임라인 (${ttsData.duration.toFixed(2)}초)`; currentCardEl.querySelector('.st-play-clip-btn').disabled = false; } updateTotalDuration(); } }, 800);
            cardEl.querySelector('textarea').addEventListener('input', (e) => { cardData.text = e.target.value; debouncedFetchAndUpdate(cardData.text, cardId); if (selectedCardId === cardId) { updatePreviewDisplay(); } });
            cardEl.querySelector('.st-btn-delete-card').addEventListener('click', (e) => { e.stopPropagation(); deleteCard(cardId); });
            cardEl.addEventListener('click', () => selectCard(cardId)); if (text) debouncedFetchAndUpdate(text, cardId); if (!selectedCardId) selectCard(cardId); updateCardNumbers();
        }

        // ✨ --- 미리보기 업데이트 함수 (레이아웃 적용 로직 추가) --- ✨
        function updatePreviewDisplay() {
            // 헤더, 프로젝트 정보 등 기존 로직
            const headerEl = document.querySelector('.st-preview-header'); if (headerEl) { headerEl.textContent = document.getElementById('st-setting-header-text')?.value || ''; headerEl.style.backgroundColor = document.getElementById('st-setting-header-bg')?.value || '#e82c43'; headerEl.style.color = document.getElementById('st-setting-header-color')?.value || '#ffffff'; headerEl.style.fontFamily = document.getElementById('st-setting-header-font')?.value || 'GmarketSans'; headerEl.style.fontSize = (document.getElementById('st-setting-header-size')?.value || '24') + 'px'; }
            const titleEl = document.querySelector('.st-project-info .title'); if (titleEl) { titleEl.textContent = document.getElementById('st-setting-project-title')?.value || ''; titleEl.style.color = document.getElementById('st-setting-title-color')?.value || '#000'; }
            const metaEl = document.querySelector('.st-project-info span'); if (metaEl) { metaEl.textContent = `${document.getElementById('st-setting-project-author')?.value || ''} | 조회수 ${Number(document.getElementById('st-setting-project-views')?.value || 0).toLocaleString()}`; metaEl.style.color = document.getElementById('st-setting-meta-color')?.value || '#555'; }
            
            // 선택된 카드 정보 가져오기
            const card = scriptCards.find(c => c.id === selectedCardId);
            const textContainer = document.getElementById('st-preview-text-container');
            const imageContainer = document.getElementById('st-preview-image-container');
            const textEl = document.getElementById('st-preview-text');
            const imageEl = document.getElementById('st-preview-image');

            if (card) {
                // 텍스트 내용 및 스타일 적용
                textEl.textContent = card.text;
                Object.assign(textEl.style, card.style);

                // 이미지 내용 적용
                if (card.imageUrl) {
                    imageEl.src = card.imageUrl;
                    imageContainer.style.display = 'block';
                } else {
                    imageContainer.style.display = 'none';
                }

                // ✨ 저장된 레이아웃 적용 ✨
                const applyLayout = (el, layout) => {
                    el.style.width = `${layout.width}px`;
                    el.style.height = `${layout.height}px`;
                    el.style.transform = `translate(${layout.x}px, ${layout.y}px)`;
                    el.setAttribute('data-x', layout.x);
                    el.setAttribute('data-y', layout.y);
                };
                applyLayout(textContainer, card.layout.text);
                applyLayout(imageContainer, card.layout.image);

            } else {
                // 선택된 카드가 없을 때 기본 상태
                textEl.textContent = '스크립트를 추가하거나 선택하세요.';
                imageContainer.style.display = 'none';
            }
        }
        
        // ✨ --- Interact.js 초기화 및 로직 --- ✨
        function initializeInteract() {
            const verticalGuide = document.querySelector('.snap-guide-v');
            const dropzone = document.querySelector('.st-script-display');
            
            const position = { x: 0, y: 0 };

            interact('.st-script-display > div')
                .draggable({
                    listeners: {
                        start(event) {
                            const rect = event.target.getBoundingClientRect();
                            position.x = parseFloat(event.target.getAttribute('data-x')) || 0;
                            position.y = parseFloat(event.target.getAttribute('data-y')) || 0;
                            event.target.classList.add('interactive-active');
                        },
                        move(event) {
                            position.x += event.dx;
                            position.y += event.dy;
                            event.target.style.transform = `translate(${position.x}px, ${position.y}px)`;

                            // ✨ 스마트 가이드 로직 ✨
                            const targetRect = event.target.getBoundingClientRect();
                            const dropzoneRect = dropzone.getBoundingClientRect();
                            const targetCenter = targetRect.left + targetRect.width / 2;
                            const dropzoneCenter = dropzoneRect.left + dropzoneRect.width / 2;

                            if (Math.abs(targetCenter - dropzoneCenter) < 5) { // 5px 이내로 가까우면
                                verticalGuide.style.left = `${dropzone.offsetWidth / 2}px`;
                                verticalGuide.style.display = 'block';
                                // 스냅: 실제 위치 보정
                                position.x -= (targetCenter - dropzoneCenter);
                                event.target.style.transform = `translate(${position.x}px, ${position.y}px)`;
                            } else {
                                verticalGuide.style.display = 'none';
                            }
                        },
                        end(event) {
                            verticalGuide.style.display = 'none';
                            event.target.setAttribute('data-x', position.x);
                            event.target.setAttribute('data-y', position.y);
                            
                            // ✨ 변경된 위치 저장 ✨
                            const card = scriptCards.find(c => c.id === selectedCardId);
                            const elType = event.target.id.includes('text') ? 'text' : 'image';
                            if (card) {
                                card.layout[elType].x = position.x;
                                card.layout[elType].y = position.y;
                            }
                        }
                    },
                    modifiers: [
                        interact.modifiers.restrictRect({
                            restriction: 'parent'
                        })
                    ]
                })
                .resizable({
                    edges: { top: true, left: true, bottom: true, right: true },
                    listeners: {
                        move: function (event) {
                            let { x, y } = event.target.dataset;
                            x = (parseFloat(x) || 0) + event.deltaRect.left;
                            y = (parseFloat(y) || 0) + event.deltaRect.top;

                            Object.assign(event.target.style, {
                                width: event.rect.width + 'px',
                                height: event.rect.height + 'px',
                                transform: 'translate(' + x + 'px,' + y + 'px)'
                            });

                            Object.assign(event.target.dataset, { x, y });
                        },
                        end(event) {
                            // ✨ 변경된 크기 저장 ✨
                             const card = scriptCards.find(c => c.id === selectedCardId);
                             const elType = event.target.id.includes('text') ? 'text' : 'image';
                             if (card) {
                                card.layout[elType].width = event.rect.width;
                                card.layout[elType].height = event.rect.height;
                             }
                        }
                    },
                    modifiers: [
                        interact.modifiers.restrictSize({
                           min: { width: 50, height: 30 }
                        }),
                         interact.modifiers.restrictRect({
                            restriction: 'parent'
                        })
                    ]
                });
            
            // 컨테이너 클릭 시 모든 active 상태 해제
            dropzone.addEventListener('click', (event) => {
                if (event.target === dropzone) {
                    document.querySelectorAll('.interactive-active').forEach(el => el.classList.remove('interactive-active'));
                }
            });
        }
        
        function selectCard(cardId, fromPlayback = false) {
            if (isPlaying && !fromPlayback) stopPlayback(); 
            selectedCardId = cardId; 
            document.querySelectorAll('.st-card').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.interactive-active').forEach(el => el.classList.remove('interactive-active'));
            const cardEl = document.querySelector(`.st-card[data-id="${cardId}"]`); 
            if (cardEl) { 
                cardEl.classList.add('active'); 
                if (!fromPlayback) cardEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                updateScriptStyleControls(); 
                updatePreviewDisplay(); 
            } else { 
                updatePreviewDisplay(); 
            }
        }

        // --- 나머지 함수들은 기존과 거의 동일합니다 ---
        const debounce = (callback, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => callback(...args), delay); }; };
        const getAudioDuration = (url) => new Promise(resolve => { const audio = new Audio(); audio.onloadedmetadata = () => resolve(audio.duration); audio.src = url; });
        function renderControls() { const fontOptions = FONT_LIST.map(font => `<option value="${font.value}" style="font-family: ${font.value};">${font.name}</option>`).join(''); const bgmOptions = BGM_LIST.map(bgm => `<option value="${bgm.url}">${bgm.name}</option>`).join(''); settingsPanel.innerHTML = ` <div class="st-accordion-item active"><div class="st-accordion-header">헤더 스타일</div><div class="st-accordion-content"> <div class="st-control-group"><label>헤더 텍스트</label><input type="text" id="st-setting-header-text" value="썰쑈"></div> <div class="st-flex-group"> <div><label>배경 색상</label><input type="color" id="st-setting-header-bg" value="#e82c43"></div> <div><label>글자 색상</label><input type="color" id="st-setting-header-color" value="#FFFFFF"></div> </div> <div class="st-flex-group"> <div><label>폰트</label><select id="st-setting-header-font">${fontOptions}</select></div> <div><label>크기</label><input type="number" id="st-setting-header-size" value="24"></div> </div> </div></div> <div class="st-accordion-item"><div class="st-accordion-header">스크립트 스타일</div><div class="st-accordion-content"><div class="st-control-group"><label>텍스트 색상</label><input type="color" id="st-setting-script-color" value="#000000"></div><div class="st-flex-group"><div><label>폰트</label><select id="st-setting-script-font">${fontOptions}</select></div><div><label>크기</label><input type="number" id="st-setting-script-size" value="24"></div></div></div></div> <div class="st-accordion-item"><div class="st-accordion-header">프로젝트 정보</div><div class="st-accordion-content"><div class="st-control-group"><label>제목</label><input type="text" id="st-setting-project-title" value=""></div><div class="st-control-group"><label>작성자</label><input type="text" id="st-setting-project-author" value=""></div><div class="st-control-group"><label>조회수</label><input type="number" id="st-setting-project-views" value="0"></div><div class="st-flex-group"><div><label>제목 색상</label><input type="color" id="st-setting-title-color" value="#000000"></div><div><label>작성자/조회수 색상</label><input type="color" id="st-setting-meta-color" value="#555555"></div></div></div></div> <div class="st-accordion-item"><div class="st-accordion-header">배경음악 설정</div><div class="st-accordion-content"><div class="st-control-group"><label>전체 배경음악 선택</label><select id="st-setting-global-bgm">${bgmOptions}</select></div><div class="st-control-group"><label>BGM 볼륨</label><input type="range" id="st-setting-global-bgm-volume" min="0" max="1" step="0.01" value="${globalBGM.volume}"></div></div></div>`; document.querySelectorAll('#st-settings-panel input, #st-settings-panel select').forEach(el => { if (el.id.includes('script')) { el.addEventListener('input', applyScriptStylesToSelectedCard); } else { el.addEventListener('input', updatePreviewDisplay); } }); document.querySelectorAll('.st-accordion-header').forEach(h => h.addEventListener('click', () => h.parentElement.classList.toggle('active'))); }
        function deleteCard(cardId) { const cardIndex = scriptCards.findIndex(c => c.id === cardId); if(cardIndex === -1) return; scriptCards.splice(cardIndex, 1); document.querySelector(`.st-card[data-id="${cardId}"]`).remove(); if (selectedCardId === cardId) { selectedCardId = null; if(scriptCards.length > 0) { const nextIndex = Math.max(0, cardIndex - 1); if (scriptCards[nextIndex]) selectCard(scriptCards[nextIndex].id); } else { updatePreviewDisplay(); } } updateTotalDuration(); updateCardNumbers(); }
        function updateCardNumbers() { document.querySelectorAll('.st-card').forEach((card, index) => { card.querySelector('.st-card-number').textContent = index + 1; }); }
        function updateTotalDuration() { const total = scriptCards.reduce((sum, card) => sum + (card.duration || 0.5), 0); }
        function showLoadingOnCard(cardId, show, message = '음성 생성 중...') { const cardEl = document.querySelector(`.st-card[data-id="${cardId}"]`); if (!cardEl) return; let overlay = cardEl.querySelector('.st-card-loading'); if (show) { if (!overlay) { overlay = document.createElement('div'); overlay.className = 'st-card-loading'; cardEl.appendChild(overlay); } overlay.textContent = message; } else { if (overlay) overlay.remove(); } }
        function updateScriptStyleControls() { const card = scriptCards.find(c => c.id === selectedCardId); if (!card) return; document.getElementById('st-setting-script-color').value = card.style?.color || '#000000'; document.getElementById('st-setting-script-font').value = card.style?.fontFamily || "'Noto Sans KR', sans-serif"; document.getElementById('st-setting-script-size').value = (card.style?.fontSize || '24px').replace('px',''); }
        function applyScriptStylesToSelectedCard() { const card = scriptCards.find(c => c.id === selectedCardId); if (!card) return; card.style = { ...card.style, color: document.getElementById('st-setting-script-color').value, fontFamily: document.getElementById('st-setting-script-font').value, fontSize: document.getElementById('st-setting-script-size').value + 'px' }; updatePreviewDisplay(); }
        function playBGM(bgmData = globalBGM) { if (bgmData && bgmData.url) { if (bgmPlayer.src !== bgmData.url) bgmPlayer.src = bgmData.url; bgmPlayer.volume = globalBGM.volume; bgmPlayer.currentTime = bgmData.startTime || 0; bgmPlayer.play().catch(e => console.error("BGM Playback Error:", e)); } else { bgmPlayer.pause(); } }
        bgmPlayer.addEventListener('timeupdate', () => { if (!isPlaying) return; if (globalBGM.endTime && bgmPlayer.currentTime >= globalBGM.endTime) { bgmPlayer.currentTime = globalBGM.startTime || 0; } });
        function togglePlay() { isPlaying ? stopPlayback() : startPlayback(); }
        function startPlayback() { const unready = scriptCards.some(c => !c.ttsReady && c.text.trim()); if (unready) return alert('아직 음성 생성이 완료되지 않은 스크립트가 있습니다.'); if (scriptCards.length === 0) return; isPlaying = true; playAllBtn.textContent = '❚❚'; playBGM(); playCardByIndex(0); }
        function stopPlayback() { isPlaying = false; playAllBtn.textContent = '▶'; ttsPlayer.pause(); bgmPlayer.pause(); sfxPlayer.pause(); }
        function playCardByIndex(index) { if (index >= scriptCards.length || !isPlaying) { stopPlayback(); return; } playbackCurrentIndex = index; const card = scriptCards[index]; selectCard(card.id, true); if (card.sfxUrl) { sfxPlayer.src = card.sfxUrl; sfxPlayer.play(); } setTimeout(() => { if (isPlaying && playbackCurrentIndex === index) { ttsPlayer.src = card.audioUrl; ttsPlayer.play(); } }, 30); ttsPlayer.onended = () => playCardByIndex(index + 1); }
        function setupGptsModal() { addGptsBtn.addEventListener('click', () => gptsModal.classList.add('visible')); function closeModal() { gptsModal.classList.remove('visible'); gptsTextarea.value = ''; } gptsCancelBtn.addEventListener('click', closeModal); gptsModal.addEventListener('click', (e) => { if (e.target === gptsModal) closeModal(); }); gptsConfirmBtn.addEventListener('click', () => { const text = gptsTextarea.value.trim(); if (!text) return; const lines = text.split(/\n\s*\n/).filter(line => line.trim() !== ''); lines.forEach(line => addScriptCard(line.trim())); closeModal(); if(lines.length > 0 && scriptCards.length > 0) { const firstNewCardId = scriptCards[scriptCards.length - lines.length].id; selectCard(firstNewCardId); } }); }
        function setupExportButton() { const exportBtn = document.getElementById('st-btn-export-video'); if (!exportBtn) return; exportBtn.addEventListener('click', async () => { if (scriptCards.some(c => !c.ttsReady && c.text.trim())) return alert('아직 음성 생성이 완료되지 않은 스크립트가 있습니다. 모두 생성된 후 시도해주세요.'); if (scriptCards.length === 0) return alert('출력할 스크립트가 없습니다.'); exportBtn.disabled = true; exportBtn.textContent = '렌더링 요청 중...'; try { const projectData = { resolution: { width: 1080, height: 1920 }, fps: 60, styles: { header: { text: document.getElementById('st-setting-header-text')?.value, backgroundColor: document.getElementById('st-setting-header-bg')?.value, color: document.getElementById('st-setting-header-color')?.value, fontFamily: document.getElementById('st-setting-header-font')?.value, fontSize: parseInt(document.getElementById('st-setting-header-size')?.value) }, projectInfo: { title: document.getElementById('st-setting-project-title')?.value, author: document.getElementById('st-setting-project-author')?.value, views: document.getElementById('st-setting-project-views')?.value, titleColor: document.getElementById('st-setting-title-color')?.value, metaColor: document.getElementById('st-setting-meta-color')?.value } }, bgm: { url: globalBGM.url, volume: globalBGM.volume, startTime: globalBGM.startTime, endTime: globalBGM.endTime }, scenes: scriptCards.map(card => ({ text: card.text, duration: card.duration, audioUrl: card.audioUrl, imageUrl: card.imageUrl, sfxUrl: card.sfxUrl, style: card.style, layout: card.layout })) }; const response = await fetch('/.netlify/functions/render-video', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(projectData) }); if (!response.ok) { const errorResult = await response.json(); throw new Error(errorResult.error || '서버에서 렌더링 요청에 실패했습니다.'); } const result = await response.json(); alert(`영상 렌더링 요청에 성공했습니다! (작업 ID: ${result.jobId})\n\n(주의: 실제 렌더링 기능은 서버에 구현이 필요합니다.)`); } catch (error) { console.error('영상 출력 요청 오류:', error); alert(`오류가 발생했습니다: ${error.message}`); } finally { exportBtn.disabled = false; exportBtn.textContent = '🎬 영상 출력 (1080p)'; } }); }
        
        function initialize() {
            renderControls(); 
            updatePreviewDisplay(); 
            addCardBtn.addEventListener('click', () => addScriptCard('')); 
            playAllBtn.addEventListener('click', togglePlay);
            setupGptsModal();
            setupExportButton();
            // BGM 편집기 로직은 생략
            document.getElementById('st-setting-global-bgm-volume').addEventListener('input', (e) => { globalBGM.volume = parseFloat(e.target.value); bgmPlayer.volume = globalBGM.volume; });
            new Sortable(cardContainer, { animation: 150, handle: '.st-card-drag-handle', onEnd: function(evt) { const { oldIndex, newIndex } = evt; const [movedItem] = scriptCards.splice(oldIndex, 1); scriptCards.splice(newIndex, 0, movedItem); updateCardNumbers(); } });
            
            // ✨ interact.js 초기화 함수 호출 ✨
            initializeInteract();
            
            addScriptCard('SunsakTool에 오신 것을 환영합니다!');
        }
        
        initialize();
    });
    </script>
</body>
</html>
