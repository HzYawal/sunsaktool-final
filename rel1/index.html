<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SunsakTool 3.0</title>
    <!-- í°íŠ¸ ë¡œë“œ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=IBM+Plex+Sans+KR:wght@400;700&family=Gowun+Dodum&family=Gowun+Batang&family=Nanum+Myeongjo:wght@400;700;800&family=Do+Hyeon&family=Black+Han+Sans&family=Gaegu:wght@400;700&family=Hi+Melody&family=Noto+Serif+KR:wght@400;700&family=Dokdo&display=swap');
        @font-face { font-family: 'Pretendard'; src: url('https://cdn.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff'); font-weight: 400; }
        @font-face { font-family: 'Spoqa Han Sans Neo'; src: url('https://cdn.jsdelivr.net/gh/spoqa/spoqa-han-sans@latest/Subset/SpoqaHanSansNeo/SpoqaHanSansNeo-Regular.woff2') format('woff2'); font-weight: 400; }
        @font-face { font-family: 'GmarketSans'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansBold.woff') format('woff'); }
        
        /* CSS ìŠ¤íƒ€ì¼ */
        :root { --st-accent-color: #e82c43; --st-bg-color: #1e1e1e; --st-panel-color: #2a2a2a; --st-border-color: #383838; --st-text-color: #e0e0e0; --st-subtext-color: #aaa; }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--st-bg-color); color: var(--st-text-color); -webkit-font-smoothing: antialiased; }

        /* âœ¨ FIX: ìµœì¢… 3ë‹¨ ë ˆì´ì•„ì›ƒ êµ¬ì¡° */
        .st-main-container { display: flex; height: 100vh; }
        .st-preview-area { flex: 0 0 400px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; background-color: var(--st-panel-color); }
        .st-editor-area { flex-grow: 1; display: flex; flex-direction: column; border-left: 1px solid var(--st-border-color); border-right: 1px solid var(--st-border-color); }
        .st-settings-area { flex: 0 0 280px; overflow-y: auto; background-color: var(--st-panel-color); }
        
        .st-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #1a1a1a; border-bottom: 1px solid var(--st-border-color); flex-shrink: 0; height: 50px; width: 100%; }
        .st-logo { font-family: 'GmarketSans', sans-serif; font-weight: bold; }
        
        .st-panel-content { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .st-editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .st-editor-header h3 { margin: 0; }
        .st-editor-header .button-group { display: flex; gap: 8px; }

        /* ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ */
        .st-preview-panel { width: 100%; max-width: 360px; aspect-ratio: 9 / 16; background-color: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; }
        .st-preview-header { font-family: 'GmarketSans', sans-serif; color: white; font-weight: bold; flex-shrink: 0; height: 65px; display: flex; justify-content: center; align-items: center; padding: 0 15px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .st-preview-content { padding: 10px; color: black; flex-grow: 1; display: flex; flex-direction: column; background-color: white; overflow: hidden; }
        .st-project-info { font-size: 13px; color: #555; margin: 0 0 16px 0; border-bottom: 1px solid #eee; padding-bottom: 16px; }
        .st-project-info .title { font-size: 22px; color: black; font-weight: bold; margin-bottom: 5px; }
        .st-script-display { flex-grow: 1; display: flex; flex-direction: column; align-items: center; text-align: center; }
        #st-preview-text { width: 100%; font-size: 24px; color: #000; white-space: pre-wrap; margin-bottom: 8px; flex-shrink: 0; }
        #st-preview-image-container { width: 100%; display: flex; justify-content: center; align-items: flex-start; }
        #st-preview-image { max-width: 100%; max-height: 100%; object-fit: contain; }
        .st-timeline-controls { width: 100%; max-width: 360px; display: flex; align-items: center; gap: 10px; margin-top: 15px;}
        .st-play-all-btn { background: none; font-size: 24px; padding: 0;}
        #st-timeline-slider { flex-grow: 1; }
        
        /* ìŠ¤í¬ë¦½íŠ¸ ì¹´ë“œ */
        #st-card-container { display: block; }
        .st-card { background-color: var(--st-panel-color); border: 2px solid transparent; padding: 15px; margin-top: 15px; border-radius: 4px; cursor: pointer; position: relative; }
        .st-card.active { border-color: var(--st-accent-color); }
        .st-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .st-card-drag-handle { cursor: grab; }
        .st-card-drag-handle:active { cursor: grabbing; }
        .st-card-number { font-weight: bold; font-size: 18px; }
        textarea { width:100%; min-height:60px; background-color: #333; border: 1px solid var(--st-border-color); color: var(--st-text-color); border-radius: 4px; padding: 8px; }
        .st-card-footer { margin-top: 10px; display: flex; align-items: center; gap: 10px; font-size: 13px; flex-wrap: wrap; }
        input[type="file"] { display: none; }
        .st-action-btn { background: none; border:none; color: var(--st-subtext-color); text-decoration: underline; cursor: pointer; padding: 0; font-size: 13px; }
        .st-play-clip-btn { font-size: 18px; background: none; padding: 0 5px; cursor: pointer; border: none; color: var(--st-text-color); }
        .st-play-clip-btn:disabled { color: #555; cursor: not-allowed; }
        .st-card-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); color: white; display: flex; justify-content: center; align-items: center; z-index: 10; border-radius: 4px; font-weight: bold; }

        /* âœ¨ FIX: ì•„ì½”ë””ì–¸ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .st-accordion-header { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid var(--st-border-color); font-weight: bold; user-select: none; }
        .st-accordion-header:hover { background-color: #333; }
        .st-accordion-content { padding: 15px; display: none; border-bottom: 1px solid var(--st-border-color); }
        .st-accordion-item.active .st-accordion-content { display: block; }
        .st-control-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 8px; background-color: #1e1e1e; border: 1px solid var(--st-border-color); color: var(--st-text-color); }
        .st-flex-group { display: flex; gap: 10px; }
        
        /* ëª¨ë‹¬ ê³µí†µ */
        .st-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .st-modal-overlay.visible { display: flex; }
        .st-modal-dialog { background-color: var(--st-panel-color); padding: 24px; border-radius: 8px; width: 90%; max-width: 600px; border: 1px solid var(--st-border-color); }
        .st-modal-dialog h2 { margin-top: 0; font-size: 18px; }
        .st-modal-dialog p { color: var(--st-subtext-color); font-size: 14px; margin-bottom: 16px; }
        .st-modal-dialog textarea { height: 250px; font-size: 14px; margin-bottom: 16px; }
        .st-modal-dialog .st-modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;}
        .st-modal-dialog .st-modal-actions button.cancel { background-color: #555; }

        /* BGM ì—ë””í„° ëª¨ë‹¬ */
        #st-waveform-container { width: 100%; height: 128px; background-color: #1e1e1e; }
        #st-waveform-loading { text-align: center; padding: 40px; color: var(--st-subtext-color); }
        .st-waveform-controls { margin-top: 15px; display: flex; gap: 10px; align-items: center;}
    </style>
</head>
<body>
    <div class="st-main-container">
        <div class="st-preview-area">
            <div class="st-preview-panel" id="st-preview-panel"></div>
            <div class="st-timeline-controls">
                <button class="st-play-all-btn" id="st-btn-play-all">â–¶</button>
                <input type="range" id="st-timeline-slider" value="0" step="0.1">
            </div>
        </div>
        <div class="st-editor-area">
            <header class="st-header">
                <div class="st-logo">SunsakTool 3.0</div>
                <div class="button-group">
                    <button id="st-btn-add-smart-script" style="background-color: #3e3e3e;">+ ìŠ¤ë§ˆíŠ¸ ëŒ€ë³¸ ë¶™ì—¬ë„£ê¸°</button>
                    <button id="st-btn-add-card">+ ë¹ˆ ì¹´ë“œ ì¶”ê°€</button>
                </div>
            </header>
            <div class="st-panel-content">
                 <div id="st-card-container"></div>
            </div>
        </div>
        <div class="st-settings-area">
            <!-- âœ¨ FIX: ì•„ì½”ë””ì–¸ ë©”ë‰´ êµ¬ì¡° -->
            <div id="st-settings-accordion">
                <div class="st-accordion-item active">
                    <div class="st-accordion-header">í—¤ë” ìŠ¤íƒ€ì¼</div>
                    <div class="st-accordion-content">
                        <div class="st-control-group">
                            <label>í—¤ë” í…ìŠ¤íŠ¸</label><input type="text" id="st-setting-header-text" value="ì°ì‘ˆ">
                            <div class="st-flex-group" style="margin-top:10px;">
                                <div><label>ë°°ê²½ ìƒ‰ìƒ</label><input type="color" id="st-setting-header-bg" value="#e82c43"></div>
                                <div><label>ê¸€ì ìƒ‰ìƒ</label><input type="color" id="st-setting-header-color" value="#FFFFFF"></div>
                            </div>
                            <div class="st-flex-group" style="margin-top:10px;">
                                <div><label>í°íŠ¸</label><select id="st-setting-header-font"></select></div>
                                <div><label>í¬ê¸°</label><input type="number" id="st-setting-header-size" value="24"></div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="st-accordion-item">
                    <div class="st-accordion-header">ìŠ¤í¬ë¦½íŠ¸ ìŠ¤íƒ€ì¼ (ì„ íƒëœ ì¹´ë“œ)</div>
                    <div class="st-accordion-content">
                        <div class="st-control-group">
                            <label>í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label><input type="color" id="st-setting-script-color" value="#000000">
                            <div class="st-flex-group" style="margin-top:10px;">
                                <div><label>í°íŠ¸</label><select id="st-setting-script-font"></select></div>
                                <div><label>í¬ê¸°</label><input type="number" id="st-setting-script-size" value="24"></div>
                            </div>
                            <div class="st-flex-group" style="margin-top:10px;">
                                <div><label>X</label><input type="number" id="st-setting-script-x" value="0"></div>
                                <div><label>Y</label><input type="number" id="st-setting-script-y" value="0"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="st-accordion-item">
                    <div class="st-accordion-header">í”„ë¡œì íŠ¸ ì •ë³´</div>
                    <div class="st-accordion-content">
                         <div class="st-control-group">
                            <label>ì œëª©</label><input type="text" id="st-setting-project-title" value="">
                            <label style="margin-top:10px;">ì‘ì„±ì</label><input type="text" id="st-setting-project-author" value="">
                            <label style="margin-top:10px;">ì¡°íšŒìˆ˜</label><input type="number" id="st-setting-project-views" value="0">
                            <div class="st-flex-group" style="margin-top:10px;">
                                <div><label>ì œëª© ìƒ‰ìƒ</label><input type="color" id="st-setting-title-color" value="#000000"></div>
                                <div><label>ì‘ì„±ì/ì¡°íšŒìˆ˜ ìƒ‰ìƒ</label><input type="color" id="st-setting-meta-color" value="#555555"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="st-accordion-item">
                    <div class="st-accordion-header">ë°°ê²½ìŒì•… ì„¤ì •</div>
                    <div class="st-accordion-content">
                         <div class="st-control-group">
                            <label>ì „ì²´ ë°°ê²½ìŒì•… ì„ íƒ</label><select id="st-setting-global-bgm"></select>
                            <label style="margin-top:10px;">BGM ë³¼ë¥¨</label><input type="range" id="st-setting-global-bgm-volume" min="0" max="1" step="0.01" value="0.3">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ì°½ë“¤ -->
    <div id="st-modal-smart-script" class="st-modal-overlay">
        <div class="st-modal-dialog">
            <h2>ìŠ¤ë§ˆíŠ¸ ëŒ€ë³¸ ë¶™ì—¬ë„£ê¸°</h2>
            <p>ëŒ€ë³¸ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. ë¹ˆ ì¤„ì„ ê¸°ì¤€ìœ¼ë¡œ ê° ë¬¸ë‹¨ì´ ë³„ê°œì˜ ìŠ¤í¬ë¦½íŠ¸ ì¹´ë“œë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</p>
            <textarea id="st-smart-script-textarea" placeholder="ì—¬ê¸°ì— ëŒ€ë³¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
            <div class="st-modal-actions">
                <button id="st-btn-smart-script-cancel" class="cancel">ì·¨ì†Œ</button>
                <button id="st-btn-smart-script-confirm">í™•ì¸</button>
            </div>
        </div>
    </div>
    <div id="st-modal-bgm" class="st-modal-overlay">
        <div class="st-modal-dialog">
            <h2>BGM êµ¬ê°„ ì„¤ì •</h2>
            <p>ì˜¤ë””ì˜¤ íŒŒí˜• ìœ„ì—ì„œ ì›í•˜ëŠ” êµ¬ê°„ì„ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.</p>
            <div id="st-waveform-container"><div id="st-waveform-loading">BGM ë¡œë”© ì¤‘...</div></div>
            <div class="st-waveform-controls">
                <button id="st-btn-bgm-play-pause">ì¬ìƒ/ì¼ì‹œì •ì§€</button>
                <button id="st-btn-bgm-play-region">ì„ íƒ êµ¬ê°„ ë¯¸ë¦¬ë“£ê¸°</button>
                <span id="st-bgm-time-display">0.00s - 0.00s</span>
            </div>
            <div class="st-modal-actions">
                <button id="st-btn-bgm-cancel" class="cancel">ì·¨ì†Œ</button>
                <button id="st-btn-bgm-confirm">í™•ì¸</button>
            </div>
        </div>
    </div>
    <audio id="st-tts-player" style="display:none;"></audio>
    <audio id="st-bgm-player" style="display:none;" loop></audio>
    <audio id="st-sfx-player" style="display:none;"></audio>
    
    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.4.0/wavesurfer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.4.0/plugin/wavesurfer.regions.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const TYPECAST_CONFIG = {
            API_KEY: '__pltLTZFuUGQsd8MrMhApakqMcVqdVkPHmR9LzvLLALT',
            ACTOR_ID: '6596849ea3ecaa12a8b13989'
        };
        
        const FONT_LIST = [
            { name: 'í”„ë¦¬í…ë‹¤ë“œ (ë³¸ë¬¸ìš© ì¶”ì²œ)', value: 'Pretendard' },
            { name: 'Noto Sans KR (ê¸°ë³¸ ê³ ë”•)', value: "'Noto Sans KR', sans-serif" },
            { name: 'Gë§ˆì¼“ ì‚°ìŠ¤ (ê°œì„±ìˆëŠ” ì œëª©)', value: 'GmarketSans' },
            { name: 'IBM Plex Sans KR (ëª¨ë˜í•œ ê³ ë”•)', value: "'IBM Plex Sans KR', sans-serif" },
            { name: 'Do Hyeon (ë ˆíŠ¸ë¡œ ì œëª©)', value: "'Do Hyeon', sans-serif" },
            { name: 'ë‚˜ëˆ”ëª…ì¡° (ê°ì„±ì ì¸ ë³¸ë¬¸)', value: "'Nanum Myeongjo', serif" },
            { name: 'ê³ ìš´ ë°”íƒ• (ë¶€ë“œëŸ¬ìš´ ëª…ì¡°)', value: "'Gowun Batang', serif" },
            { name: 'Black Han Sans (ê°•ë ¥í•œ ì œëª©)', value: "'Black Han Sans', sans-serif" },
            { name: 'ê°œêµ¬ (ê·€ì—¬ìš´ ì†ê¸€ì”¨)', value: "'Gaegu', cursive" },
            { name: 'Hi Melody (ì•„ê¸°ìê¸° ì†ê¸€ì”¨)', value: "'Hi Melody', cursive" },
            { name: 'Noto Serif KR (ì •ê°ˆí•œ ëª…ì¡°)', value: "'Noto Serif KR', serif" },
            { name: 'ìŠ¤í¬ì¹´ í•œ ì‚°ìŠ¤ ë„¤ì˜¤ (ê¹”ë”í•œ ë³¸ë¬¸)', value: "'Spoqa Han Sans Neo', sans-serif" },
            { name: 'ë…ë„ (ê±°ì¹œ ë¶“ê¸€ì”¨)', value: "'Dokdo', cursive" },
        ];

        const BGM_LIST = [
            { name: 'ì„ íƒ ì•ˆí•¨', url: '' },
            { name: 'big-cafe', url: 'https://sunsaktool-final.netlify.app/big-cafe.mp3' },
            { name: 'blue-jacket', url: 'https://sunsaktool-final.netlify.app/blue-jacket.mp3' },
            { name: 'cute-puppy', url: 'https://sunsaktool-final.netlify.app/cute-puppy.mp3' },
            { name: 'laughter-in-the-breeze', url: 'https://sunsaktool-final.netlify.app/laughter-in-the-breeze-_happy_.mp3' },
            { name: 'murder-in-my-mind', url: 'https://sunsaktool-final.netlify.app/murder-in-my-mind.mp3' },
            { name: 'smiley-composure', url: 'https://sunsaktool-final.netlify.app/smiley-composure.mp3' },
            { name: 'spider', url: 'https://sunsaktool-final.netlify.app/spider.mp3' },
            { name: 'white-color', url: 'https://sunsaktool-final.netlify.app/white-color.mp3' }
        ];
        
        const SFX_LIST = [
            { name: 'íš¨ê³¼ìŒ ì—†ìŒ', url: '' },
            { name: 'ë¾± (ë¬¼ë°©ìš¸)', url: `https://sunsaktool-final.netlify.app/sfx/062_${encodeURIComponent('ë¾± (ë¬¼ë°©ìš¸)')}.mp3` },
            { name: 'ì°°ì¹µ (ì¹´ë©”ë¼)', url: `https://sunsaktool-final.netlify.app/sfx/078_${encodeURIComponent('ì°°ì¹µ (ì¹´ë©”ë¼)')}.mp3` },
            { name: 'ê¸°ì–´ 1', url: 'https://sunsaktool-final.netlify.app/sfx/gears 1.wav' },
            { name: 'ê²Œì„í´ë¦¬ì–´ (ê³ ìŒ)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ê²Œì„í´ë¦¬ì–´ (ê³ ìŒ)')}.mp3` },
            { name: 'ê¸ì •ì  ë§ˆë²• ì‚¬ìš©', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ê¸ì •ì  ë§ˆë²• ì‚¬ìš©')}.mp3` },
            { name: 'ê¹¨ë‹¬ìŒ(ë¾°ë´‰)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ê¹¨ë‹¬ìŒì„ ì–»ì—ˆì„ ë•Œ(ë¾°ë´‰)')}.mp3` },
            { name: 'ë†€ëŒ ë°˜ì „', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë†€ëŒ ë°˜ì „')}.mp3` },
            { name: 'ë‹¤ìŒ ì¥ë©´ì „í™˜(ë¾°ë¡œë¡±)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë‹¤ìŒ ì¥ë©´ì „í™˜(ë¾°ë¡œë¡±)')}.mp3` },
            { name: 'ë„˜ì–´ê°€ëŠ” ë§‘ì€ ì†Œë¦¬(ë ë§~)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ë§‘ì€ ì†Œë¦¬(ë ë§~)')}.mp3` },
            { name: 'ë™ì „ë¨¹ëŠ”ì†Œë¦¬ 2ì—°ì†(ì¤‘ìŒ)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë™ì „ë¨¹ëŠ”ì†Œë¦¬ 2ì—°ì†(ì¤‘ìŒ)')}.mp3` },
            { name: 'ë”©ë™ëŒ•ë™ (ì „ììŒ)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë”©ë™ëŒ•ë™ (ì „ììŒ)')}.mp3` },
            { name: 'ë¬¸ì ì „ì†¡ìŒ(ë˜ë¡œë¡±)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë¬¸ì ì „ì†¡ìŒ(ë˜ë¡œë¡±)')}.mp3` },
            { name: 'ë³µì‹± íƒ€ì´ë¨¸(ë•¡ë•¡ë•¡)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë³µì‹± í›ˆë ¨ íƒ€ì´ë¨¸ê°€ ìš¸ë¦¬ëŠ” ì†Œë¦¬ (ë•¡ë•¡ë•¡)')}.mp3` },
            { name: 'ë¹„ë””ì˜¤ ë¹¨ë¦¬ê°ê¸° ì˜ˆëŠ¥ìŒ', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë¹„ë””ì˜¤ í…Œì´í”„ ë¹¨ë¦¬ê°ê¸° ì˜ˆëŠ¥ìŒ')}.mp3` },
            { name: 'ë¾°ë¡œë¡±', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ë¾°ë¡œë¡±')}.mp3` },
            { name: 'íœ™ ë‚ ì¹´ë¡­ê²Œ ì§€ë‚˜ê°€ëŠ”', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('íœ™ ë‚ ì¹´ë¡­ê²Œ ì§€ë‚˜ê°€ëŠ”')}.mp3` },
            { name: 'ì‹œí•œí­íƒ„ ì´ˆì‹œê³„ (timer)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì‹œí•œí­íƒ„ ì´ˆì‹œê³„ (timer)')}.mp3` },
            { name: 'ì•ŒëŒ ì‹œê°„ ì¢…ë£Œ -2 (ì°¨ë¶„_ beep)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì•ŒëŒ ì‹œê°„ ì¢…ë£Œ -2 (ì°¨ë¶„_ beep)')}.mp3` },
            { name: 'ì—˜ë¦¬ë² ì´í„° ë„ì°©ìŒ2 (ëµë™)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì—˜ë¦¬ë² ì´í„° ë„ì°©ìŒ2 (ëµë™)')}.mp3` },
            { name: 'ìš• ê°€ë¦¬ëŠ” ì‚ì²˜ë¦¬', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ìš• ê°€ë¦¬ëŠ” ì‚ì²˜ë¦¬')}.mp3` },
            { name: 'ì‘ì€ ì¹´ë©”ë¼ ì°°ì¹µ ì†Œë¦¬', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì‘ì€ ì¹´ë©”ë¼ ì°°ì¹µ ì†Œë¦¬')}.mp3` },
            { name: 'ì €ë…ìˆ² (ê°œêµ¬ë¦¬, ê³¤ì¶©)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì €ë…ìˆ² (ê°œêµ¬ë¦¬ì™€ ê³¤ì¶©ìš¸ìŒì†Œë¦¬)')}.mp3` },
            { name: 'í”Œë˜ë˜ ê±¸ì–´ê°€ëŠ” ì†Œë¦¬(ë½€ë³µ)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('í”Œë˜ë˜ ê±¸ì–´ê°€ëŠ” ì†Œë¦¬(ë½€ë³µ)')}.mp3` },
            { name: 'ì²œì‚¬ì˜ ê°•ë¦¼', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì²œì‚¬ì˜ ê°•ë¦¼')}.mp3` },
            { name: 'ê°œì„œ (ì² ì»¥ì¿µ)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ê°œì„œ (ì² ì»¥ì¿µ)')}.mp3` },
            { name: 'ì»´í“¨í„° í‚¤ë³´ë“œ íƒ€ì', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('ì»´í“¨í„° í‚¤ë³´ë“œ íƒ€ì')}.mp3` },
            { name: 'íƒ€ì´ë¨¸ (ì§¸ê¹ì§¸ê¹)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('íƒ€ì´ë¨¸ ì¬ëŠ” ì‹œê³„ìŒ(ì§¸ê¹ì§¸ê¹)')}.mp3` },
            { name: 'í™©ë‹¹í•  ë•Œ (ë ìš”ì˜¹)', url: `https://sunsaktool-final.netlify.app/sfx/mp_${encodeURIComponent('í™©ë‹¹í•  ë•Œ íš¨ê³¼ìŒ (ë ìš”ì˜¹)')}.mp3` },
            { name: 'Riser 1', url: 'https://sunsaktool-final.netlify.app/sfx/riser 1.wav' },
            { name: 'Whoosh 1', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh1.mp3' },
            { name: 'Whoosh 2', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh2.mp3' },
            { name: 'Whoosh 3', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh3.wav' },
            { name: 'Whoosh 4', url: 'https://sunsaktool-final.netlify.app/sfx/whoosh4.mp3' },
            { name: 'ë˜ë¡œë¡±', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë˜ë¡œë¡±')}.wav` },
            { name: 'ë˜ì•„ì•™', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë˜ì•„ì•™')}.wav` },
            { name: 'ë ë¡œë¡', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë ë¡œë¡')}.mp3` },
            { name: 'ë ë¡±(ìŠˆí¼ë§ˆë¦¬ì˜¤)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë ë¡±_ìŠˆí¼ë§ˆë¦¬ì˜¤')}.mp3` },
            { name: 'ë ë¦¬ë§', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë ë¦¬ë§')}.wav` },
            { name: 'ë ë§ 1', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§1.wav' },
            { name: 'ë ë§ 1ì´ˆ', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§1ì´ˆ.mp3' },
            { name: 'ë ë§ 2', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§2.mp3' },
            { name: 'ë ë§ 2ì´ˆ', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§2ì´ˆ.mp3' },
            { name: 'ë ë§ 3', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§3.mp3' },
            { name: 'ë ë§ 4', url: 'https://sunsaktool-final.netlify.app/sfx/ë ë§4.wav' },
            { name: 'ëµ', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ëµ')}.mp3` },
            { name: 'ë§ˆìš°ìŠ¤í´ë¦­(ë”¸ê¹)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ë§ˆìš°ìŠ¤í´ë¦­_ë”¸ê¹')}.mp3` },
            { name: 'ë¾°ì˜¥ 1', url: 'https://sunsaktool-final.netlify.app/sfx/ë¾°ì˜¥1.wav' },
            { name: 'ë¾°ì˜¥ 2', url: 'https://sunsaktool-final.netlify.app/sfx/ë¾°ì˜¥2.mp3' },
            { name: 'ë¾°ì˜¥ 3', url: 'https://sunsaktool-final.netlify.app/sfx/ë¾°ì˜¥3.wav' },
            { name: 'ë½ 1ì´ˆ', url: 'https://sunsaktool-final.netlify.app/sfx/ë½1ì´ˆ.mp3' },
            { name: 'ì‚ë¦¬ì‚ë¹…', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì‚ë¦¬ì‚ë¹…')}.mp3` },
            { name: 'ì‚‘', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì‚‘')}.mp3` },
            { name: 'ì…”í„°', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì…”í„°')}.wav` },
            { name: 'ìŠ‰ 1ì´ˆ', url: 'https://sunsaktool-final.netlify.app/sfx/ìŠ‰1ì´ˆ.mp3' },
            { name: 'ìŠ¤ìœ½', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ìŠ¤ìœ½')}.mp3` },
            { name: 'ì˜ˆ!', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì˜ˆ!')}.mp3` },
            { name: 'ì™€ìš°', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì™€ìš°')}.wav` },
            { name: 'ì°°ì¹µ(ì†Œë¦¬)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ì°°ì¹µ')}.wav` },
            { name: 'ìºì„œ', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('ìºì„œ')}.mp3` },
            { name: 'í‚¤ë³´ë“œíƒ€ì´í•‘', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('í‚¤ë³´ë“œíƒ€ì´í•‘')}.mp3` },
            { name: 'íˆ½', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('íˆ½')}.mp3` },
            { name: 'í­ë°œ 1', url: 'https://sunsaktool-final.netlify.app/sfx/í­ë°œ1.mp3' },
            { name: 'í­ë°œ 2', url: 'https://sunsaktool-final.netlify.app/sfx/í­ë°œ2.mp3' },
            { name: 'í­ë°œ(í°)', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('í­ë°œ_í°')}.mp3` },
            { name: 'í›„ìš±', url: `https://sunsaktool-final.netlify.app/sfx/${encodeURIComponent('í›„ìš±')}.mp3` }
        ];
    
        let globalBGM = { url: null, volume: 0.3, startTime: 0, endTime: null };
        let scriptCards = [];
        let isPlaying = false;
        let ttsCache = new Map();
        let playbackCurrentIndex = 0;
        let selectedCardId = null;

        const cardContainer = document.getElementById('st-card-container');
        const playAllBtn = document.getElementById('st-btn-play-all');
        const timelineSlider = document.getElementById('st-timeline-slider');
        const ttsPlayer = document.getElementById('st-tts-player');
        const bgmPlayer = document.getElementById('st-bgm-player');
        const sfxPlayer = document.getElementById('st-sfx-player'); 
        const addCardBtn = document.getElementById('st-btn-add-card');
        
        const addSmartScriptBtn = document.getElementById('st-btn-add-smart-script');
        const smartScriptModal = document.getElementById('st-modal-smart-script');
        const smartScriptCancelBtn = document.getElementById('st-btn-smart-script-cancel');
        const smartScriptConfirmBtn = document.getElementById('st-btn-smart-script-confirm');
        const smartScriptTextarea = document.getElementById('st-smart-script-textarea');

        let wavesurfer = null;
        let activeRegion = null;
        let bgmEditorContext = { callback: null, currentBgm: null };
        
        function initializeBgmEditor() {
            if (wavesurfer) {
                wavesurfer.destroy();
            }
            if (typeof WaveSurfer === 'undefined') { 
                return alert("BGM í¸ì§‘ê¸° ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”."); 
            }
            
            wavesurfer = WaveSurfer.create({
                container: '#st-waveform-container', waveColor: '#ddd', progressColor: '#e82c43', cursorColor: '#fff', barWidth: 2, barRadius: 3,
                plugins: [
                    WaveSurfer.regions.create({
                        dragSelection: {
                            slop: 5
                        }
                    })
                ]
            });

            wavesurfer.on('error', (err) => {
                console.error('WaveSurfer Error:', err);
                alert('BGM íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err);
                closeBgmEditor();
            });

            wavesurfer.on('ready', () => {
                document.getElementById('st-waveform-loading').style.display = 'none';
                wavesurfer.clearRegions();
                const totalDuration = wavesurfer.getDuration();
                const fixedRegionDuration = 60;
                
                let region = wavesurfer.addRegion({
                    start: 0,
                    color: 'rgba(232, 44, 67, 0.3)',
                });

                if (totalDuration > fixedRegionDuration) {
                    region.end = fixedRegionDuration;
                    region.drag = false;
                    region.resize = false;
                    document.getElementById('st-bgm-time-display').textContent = `0.00s - ${fixedRegionDuration.toFixed(2)}s`;
                } else {
                    region.end = totalDuration;
                    wavesurfer.plugins[0].params.dragSelection = true;
                    document.getElementById('st-bgm-time-display').textContent = `0.00s - ${totalDuration.toFixed(2)}s`;
                }
                activeRegion = region;
            });

            wavesurfer.on('region-update-end', (region) => {
                activeRegion = region;
                document.getElementById('st-bgm-time-display').textContent = `${region.start.toFixed(2)}s - ${region.end.toFixed(2)}s`;
            });

            document.getElementById('st-btn-bgm-play-pause').addEventListener('click', () => wavesurfer.playPause());
            document.getElementById('st-btn-bgm-play-region').addEventListener('click', () => { if (activeRegion) activeRegion.play(); });
            document.getElementById('st-btn-bgm-confirm').addEventListener('click', () => {
                if (bgmEditorContext.callback) {
                    const startTime = activeRegion ? activeRegion.start : 0;
                    const endTime = activeRegion ? activeRegion.end : wavesurfer.getDuration();
                    bgmEditorContext.callback({ startTime, endTime });
                }
                closeBgmEditor();
            });
            document.getElementById('st-btn-bgm-cancel').addEventListener('click', closeBgmEditor);
        }

        function openBgmEditor(url, currentBgm, callback) {
            bgmEditorContext = { callback, currentBgm };
            document.getElementById('st-modal-bgm').classList.add('visible');
            document.getElementById('st-waveform-loading').style.display = 'block';
            if (!wavesurfer) initializeBgmEditor();
            else if(wavesurfer.getDuration() > 0) {
                wavesurfer.destroy();
                initializeBgmEditor();
            }
            wavesurfer.load(url);
        }

        function closeBgmEditor() {
            document.getElementById('st-modal-bgm').classList.remove('visible');
            if (wavesurfer) {
                wavesurfer.stop();
            }
        }

        const debounce = (callback, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => callback(...args), delay); }; };
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const getAudioDuration = (url) => new Promise(resolve => { const audio = new Audio(); audio.onloadedmetadata = () => resolve(audio.duration); audio.src = url; });

        async function pollAndDownload(pollingUrl) {
            for (let i = 0; i < 15; i++) {
                const response = await fetch(pollingUrl, { headers: { 'Authorization': `Bearer ${TYPECAST_CONFIG.API_KEY}` } });
                if (!response.ok) throw new Error(`[${response.status}] Polling failed`);
                const resultJson = await response.json();
                const result = resultJson.result;
                if (result.status === 'done') {
                    const downloadUrl = result.audio_download_url;
                    if (!downloadUrl) throw new Error("Status is done, but audio_download_url is missing.");
                    const audioResponse = await fetch(downloadUrl);
                    if (!audioResponse.ok) throw new Error('Audio download failed.');
                    const audioBlob = await audioResponse.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    return { audioUrl, duration: await getAudioDuration(audioUrl) };
                } else if (result.status === 'progress') {
                    await sleep(1000);
                } else { throw new Error(`TTS job failed with status: ${result.status}`); }
            }
            throw new Error('TTS job timed out.');
        }
        
        async function fetchTTS(text, cardId) {
            text = text.trim();
            if (!text) return null;
            const cacheKey = `${text}-${TYPECAST_CONFIG.ACTOR_ID}`;
            if (ttsCache.has(cacheKey)) return ttsCache.get(cacheKey);
            showLoadingOnCard(cardId, true, 'ìš”ì²­ ì¤‘...');
            try {
                const initialResponse = await fetch('https://typecast.ai/api/speak', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TYPECAST_CONFIG.API_KEY}` },
                    body: JSON.stringify({ text, actor_id: TYPECAST_CONFIG.ACTOR_ID, lang: "auto", tempo: 1.5, xapi_hd: true, model_version: "latest" })
                });
                if (!initialResponse.ok) { const errorJson = await initialResponse.json(); throw new Error(`[${initialResponse.status}] ${errorJson.message || 'Initial request failed'}`); }
                const initialJson = await initialResponse.json();
                const pollingUrl = initialJson.result?.speak_v2_url;
                if (!pollingUrl) throw new Error('API ì‘ë‹µì— speak_v2_urlì´ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
                showLoadingOnCard(cardId, true, 'ìŒì„± ë³€í™˜ ì¤‘...');
                const result = await pollAndDownload(pollingUrl);
                ttsCache.set(cacheKey, result);
                return result;
            } catch (error) {
                console.error(error); alert(`ìŒì„± ìƒì„± ì˜¤ë¥˜: ${error.message}`); 
                return null;
            } finally {
                showLoadingOnCard(cardId, false);
            }
        }
        
        function populateSelect(selectId, list) {
             const selectEl = document.getElementById(selectId);
             selectEl.innerHTML = list.map(item => `<option value="${item.value}" style="font-family: ${item.value};">${item.name}</option>`).join('');
        }

        function renderControls() {
            populateSelect('st-setting-header-font', FONT_LIST);
            populateSelect('st-setting-script-font', FONT_LIST);
            document.getElementById('st-setting-global-bgm').innerHTML = BGM_LIST.map(bgm => `<option value="${bgm.url}">${bgm.name}</option>`).join('');
        }

        function addScriptCard(text = '') {
            const cardId = `card-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
            const cardData = { id: cardId, text, duration: 0.5, imageUrl: null, style: {}, audioUrl: null, ttsReady: false, sfxUrl: null };
            scriptCards.push(cardData);
            const cardEl = document.createElement('div');
            cardEl.className = 'st-card';
            cardEl.dataset.id = cardId;
            
            const sfxOptions = SFX_LIST.map(sfx => `<option value="${sfx.url || ''}">${sfx.name}</option>`).join('');
            cardEl.innerHTML = `<div class="st-card-header st-card-drag-handle"><span class="st-card-number"></span><button class="st-btn-delete-card">ğŸ—‘ï¸</button></div>
                              <textarea placeholder="ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">${text}</textarea>
                              <div class="st-card-footer">
                                <button class="st-play-clip-btn" title="ë¯¸ë¦¬ë“£ê¸°" disabled>â–¶ï¸</button>
                                <span class="st-duration-label">íƒ€ì„ë¼ì¸ (---ì´ˆ)</span>
                                <label class="st-action-btn" for="${cardId}-file">ì´ë¯¸ì§€</label>
                                <input type="file" id="${cardId}-file" accept="image/*">
                                <select class="st-sfx-select" style="width: auto; margin-left: auto;">${sfxOptions}</select>
                              </div>`;
            cardContainer.appendChild(cardEl);
            
            const fileInput = cardEl.querySelector(`#${cardId}-file`);
            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        cardData.imageUrl = event.target.result;
                        if (selectedCardId === cardId) updatePreviewDisplay();
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            cardEl.querySelector('.st-play-clip-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if (isPlaying) stopPlayback();
                if (cardData.ttsReady && cardData.audioUrl) {
                    ttsPlayer.src = cardData.audioUrl;
                    ttsPlayer.play();
                }
            });

            cardEl.querySelector('.st-sfx-select').addEventListener('change', (e) => { cardData.sfxUrl = e.target.value || null; });

            const debouncedFetchAndUpdate = debounce(async (newText, id) => {
                const cardToUpdate = scriptCards.find(c => c.id === id);
                if (!cardToUpdate) return;
                const ttsData = await fetchTTS(newText, id);
                if (ttsData && cardToUpdate) {
                    cardToUpdate.duration = ttsData.duration;
                    cardToUpdate.audioUrl = ttsData.audioUrl;
                    cardToUpdate.ttsReady = true;
                    const currentCardEl = document.querySelector(`.st-card[data-id="${id}"]`);
                    if(currentCardEl) {
                        currentCardEl.querySelector('.st-duration-label').textContent = `íƒ€ì„ë¼ì¸ (${ttsData.duration.toFixed(2)}ì´ˆ)`;
                        currentCardEl.querySelector('.st-play-clip-btn').disabled = false;
                    }
                    updateTotalDuration();
                }
            }, 800);

            cardEl.querySelector('textarea').addEventListener('input', (e) => { cardData.text = e.target.value; debouncedFetchAndUpdate(cardData.text, cardId); });
            cardEl.querySelector('.st-btn-delete-card').addEventListener('click', (e) => { e.stopPropagation(); deleteCard(cardId); });
            cardEl.addEventListener('click', () => selectCard(cardId));
            if (text) debouncedFetchAndUpdate(text, cardId);
            if (scriptCards.length === 1) selectCard(cardId);
            updateCardNumbers();
        }
        
        function deleteCard(cardId) {
            const cardIndex = scriptCards.findIndex(c => c.id === cardId);
            if(cardIndex === -1) return;
            scriptCards.splice(cardIndex, 1);
            document.querySelector(`.st-card[data-id="${cardId}"]`).remove();
            if (selectedCardId === cardId) {
                selectedCardId = null;
                if(scriptCards.length > 0) {
                    const nextIndex = Math.max(0, cardIndex - 1);
                    if (scriptCards[nextIndex]) selectCard(scriptCards[nextIndex].id);
                } else {
                    updatePreviewDisplay();
                }
            }
            updateTotalDuration();
            updateCardNumbers();
        }

        function updateCardNumbers() { cardContainer.querySelectorAll('.st-card').forEach((card, index) => { card.querySelector('.st-card-number').textContent = index + 1; }); }
        function updateTotalDuration() { const total = scriptCards.reduce((sum, card) => sum + (card.duration || 0.5), 0); timelineSlider.max = total; }
        function showLoadingOnCard(cardId, show, message = 'ìŒì„± ìƒì„± ì¤‘...') {
            const cardEl = document.querySelector(`.st-card[data-id="${cardId}"]`);
            if (!cardEl) return;
            let overlay = cardEl.querySelector('.st-card-loading');
            if (show) {
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.className = 'st-card-loading';
                    cardEl.appendChild(overlay);
                }
                overlay.textContent = message;
            } else {
                if (overlay) overlay.remove();
            }
        }

        function selectCard(cardId, fromPlayback = false) {
            if (isPlaying && !fromPlayback) stopPlayback();
            selectedCardId = cardId;
            document.querySelectorAll('.st-card').forEach(c => c.classList.remove('active'));
            const cardEl = document.querySelector(`.st-card[data-id="${cardId}"]`);
            if (cardEl) {
                cardEl.classList.add('active');
                if (!fromPlayback) cardEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                updateScriptStyleControls();
                updatePreviewDisplay();
            } else {
                updatePreviewDisplay();
            }
        }

        function updatePreviewDisplay() {
            const headerEl = document.querySelector('.st-preview-header');
            if (headerEl) {
                headerEl.textContent = document.getElementById('st-setting-header-text')?.value || '';
                headerEl.style.backgroundColor = document.getElementById('st-setting-header-bg')?.value || '#e82c43';
                headerEl.style.color = document.getElementById('st-setting-header-color')?.value || '#ffffff';
                headerEl.style.fontFamily = document.getElementById('st-setting-header-font')?.value || 'GmarketSans';
                headerEl.style.fontSize = (document.getElementById('st-setting-header-size')?.value || '24') + 'px';
            }
            const titleEl = document.querySelector('.st-project-info .title');
            if (titleEl) {
                titleEl.textContent = document.getElementById('st-setting-project-title')?.value || '';
                titleEl.style.color = document.getElementById('st-setting-title-color')?.value || '#000';
            }
            const metaEl = document.querySelector('.st-project-info span');
            if (metaEl) {
                metaEl.textContent = `${document.getElementById('st-setting-project-author')?.value || ''} | ì¡°íšŒìˆ˜ ${Number(document.getElementById('st-setting-project-views')?.value || 0).toLocaleString()}`;
                metaEl.style.color = document.getElementById('st-setting-meta-color')?.value || '#555';
            }
            const card = scriptCards.find(c => c.id === selectedCardId);
            const previewText = document.getElementById('st-preview-text');
            const previewImage = document.getElementById('st-preview-image');
            if (!previewText || !previewImage) return;
            previewText.textContent = card ? card.text : 'ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”.';
            
            if (card && card.imageUrl) {
                previewImage.src = card.imageUrl;
                previewImage.style.display = 'block';
            } else {
                previewImage.src = '';
                previewImage.style.display = 'none';
            }

            if (card) {
                Object.assign(previewText.style, {
                    color: card.style.color || '#000',
                    fontFamily: card.style.fontFamily || 'Noto Sans KR',
                    fontSize: card.style.fontSize || '24px',
                    transform: card.style.transform || 'translate(0px, 0px)'
                });
            } else {
                 Object.assign(previewText.style, {
                    color: '#000', fontFamily: 'Noto Sans KR', fontSize: '24px', transform: 'translate(0px, 0px)'
                });
            }
        }

        function updateScriptStyleControls() {
            const card = scriptCards.find(c => c.id === selectedCardId); if (!card) return;
            document.getElementById('st-setting-script-color').value = card.style?.color || '#000000';
            document.getElementById('st-setting-script-font').value = card.style?.fontFamily || "'Noto Sans KR', sans-serif";
            document.getElementById('st-setting-script-size').value = (card.style?.fontSize || '24px').replace('px','');
            const [x, y] = (card.style?.transform || 'translate(0px, 0px)').match(/-?\d+/g) || ['0', '0'];
            document.getElementById('st-setting-script-x').value = x;
            document.getElementById('st-setting-script-y').value = y;
        }

        function applyScriptStylesToSelectedCard() {
            const card = scriptCards.find(c => c.id === selectedCardId); if (!card) return;
            card.style = {
                color: document.getElementById('st-setting-script-color').value,
                fontFamily: document.getElementById('st-setting-script-font').value,
                fontSize: document.getElementById('st-setting-script-size').value + 'px',
                transform: `translate(${document.getElementById('st-setting-script-x').value}px, ${document.getElementById('st-setting-script-y').value}px)`
            };
            updatePreviewDisplay();
        }

        function playBGM(bgmData = globalBGM) {
            if (bgmData && bgmData.url) {
                if (bgmPlayer.src !== bgmData.url) bgmPlayer.src = bgmData.url;
                bgmPlayer.volume = globalBGM.volume;
                bgmPlayer.currentTime = bgmData.startTime || 0;
                bgmPlayer.play().catch(e => console.error("BGM Playback Error:", e));
            } else {
                bgmPlayer.pause();
            }
        }
        bgmPlayer.addEventListener('timeupdate', () => { if (!isPlaying) return; if (globalBGM.endTime && bgmPlayer.currentTime >= globalBGM.endTime) { bgmPlayer.currentTime = globalBGM.startTime || 0; } });

        function togglePlay() { isPlaying ? stopPlayback() : startPlayback(); }
        function startPlayback() {
            const unready = scriptCards.some(c => !c.ttsReady && c.text.trim());
            if (unready) return alert('ì•„ì§ ìŒì„± ìƒì„±ì´ ì™„ë£Œë˜ì§€ ì•Šì€ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.');
            if (scriptCards.length === 0) return;
            isPlaying = true;
            playAllBtn.textContent = 'âšâš';
            playBGM();
            playCardByIndex(0);
        }

        function stopPlayback() {
            isPlaying = false;
            playAllBtn.textContent = 'â–¶';
            ttsPlayer.pause();
            bgmPlayer.pause();
            sfxPlayer.pause();
        }

        function playCardByIndex(index) {
            if (index >= scriptCards.length || !isPlaying) {
                stopPlayback();
                return;
            }
            playbackCurrentIndex = index;
            const card = scriptCards[index];
            selectCard(card.id, true);

            if (card.sfxUrl) {
                sfxPlayer.src = card.sfxUrl;
                sfxPlayer.play();
            }
            
            setTimeout(() => {
                if (isPlaying && playbackCurrentIndex === index) {
                    ttsPlayer.src = card.audioUrl;
                    ttsPlayer.play();
                }
            }, 30);
            
            ttsPlayer.onended = () => playCardByIndex(index + 1);
        }
        
        function setupSmartScriptModal() {
            addSmartScriptBtn.addEventListener('click', () => smartScriptModal.classList.add('visible'));

            function closeModal() {
                smartScriptModal.classList.remove('visible');
                smartScriptTextarea.value = '';
            }

            smartScriptCancelBtn.addEventListener('click', closeModal);
            smartScriptModal.addEventListener('click', (e) => { if (e.target === smartScriptModal) closeModal(); });
            smartScriptConfirmBtn.addEventListener('click', () => {
                const text = smartScriptTextarea.value.trim();
                if (!text) return;

                const lines = text.split(/\n\s*\n/).filter(line => line.trim() !== '');
                lines.forEach(line => addScriptCard(line.trim()));

                closeModal();
                
                if(lines.length > 0 && scriptCards.length > 0) {
                     const firstNewCardId = scriptCards[scriptCards.length - lines.length].id;
                     selectCard(firstNewCardId);
                }
            });
        }

        function setupAccordionMenu() {
            const accordionHeaders = document.querySelectorAll('.st-accordion-header');
            accordionHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const activeItem = document.querySelector('.st-accordion-item.active');
                    if (activeItem && activeItem !== header.parentElement) {
                        activeItem.classList.remove('active');
                    }
                    header.parentElement.classList.toggle('active');
                });
            });
        }

        function initialize() {
            // í”„ë¦¬ë·° íŒ¨ë„ ì´ˆê¸°í™”
            document.getElementById('st-preview-panel').innerHTML = `
                <div class="st-preview-header"></div><div class="st-preview-content"><div class="st-project-info"><div class="title"></div><span></span></div>
                <div class="st-script-display"><div id="st-preview-text"></div><div id="st-preview-image-container"><img id="st-preview-image"></div></div></div>`;
            
            // ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë Œë”ë§ ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
            renderControls();
            document.querySelectorAll('.st-accordion-content input, .st-accordion-content select').forEach(el => {
                el.addEventListener('input', (e) => {
                    if (el.id.includes('script')) {
                        applyScriptStylesToSelectedCard();
                    } else {
                        updatePreviewDisplay();
                    }
                });
            });

            // ë‚˜ë¨¸ì§€ ì´ˆê¸°í™”
            setupAccordionMenu();
            addCardBtn.addEventListener('click', () => addScriptCard(''));
            playAllBtn.addEventListener('click', togglePlay);
            setupSmartScriptModal();

            document.getElementById('st-setting-global-bgm').addEventListener('change', (e) => {
                const url = e.target.value;
                if (url) { openBgmEditor(url, globalBGM, ({ startTime, endTime }) => { globalBGM = { ...globalBGM, url, startTime, endTime }; if (isPlaying) playBGM(); });
                } else { globalBGM.url = null; if (isPlaying) bgmPlayer.pause(); }
            });
            document.getElementById('st-setting-global-bgm-volume').addEventListener('input', (e) => { globalBGM.volume = parseFloat(e.target.value); if(bgmPlayer) bgmPlayer.volume = globalBGM.volume; });

            new Sortable(cardContainer, {
                animation: 150,
                handle: '.st-card-drag-handle',
                onEnd: function(evt) {
                    const { oldIndex, newIndex } = evt;
                    const [movedItem] = scriptCards.splice(oldIndex, 1);
                    scriptCards.splice(newIndex, 0, movedItem);
                    updateCardNumbers();
                }
            });

            addScriptCard('SunsakTool 2.0ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!');
            updatePreviewDisplay();
        }
        
        initialize();
    });
    </script>
</body>
</html>
